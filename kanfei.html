<!-- קוד JS הועבר ל-head -->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="he-IL" translate="no">

<head>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charset="UTF-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="robots" content="noindex" />

    <link rel="preload" as="image" href="waitnew.gif">
    <link href="https://fonts.googleapis.com/css?family=Assistant:400,600,700&display=swap&subset=hebrew"
        rel="stylesheet" />
    <link rel="stylesheet" href="Files/signature-pad.css" />
    <link rel="stylesheet" type="text/css" href="Files/sweetalert.css?0" />

    <script src="Files/sweetalert.min.js"></script>
    <script type="text/javascript" src="Files/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="Files/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">


    <title>טופס - נדרים פלוס</title>

    <script type="text/javascript">
        // פופאפ הדפסה להזמנות שטופלו
        function openPrintQueuePopup() {
            swal({
                title: 'הדפסת הזמנה',
                type: 'input',
                inputPlaceholder: 'הזן מס\' הזמנה',
                showCancelButton: true,
                confirmButtonText: 'חפש',
                cancelButtonText: 'סגור',
                customClass: 'print-queue-popup',
                showLoaderOnConfirm: true,
                closeOnConfirm: false,
                closeOnCancel: true
            }, function (inputValue) {
                // SweetAlert v1 passes the input value to the callback, or false when cancelled
                if (inputValue === false) return; // cancelled
                var collectionIndex = (typeof inputValue === 'string') ? inputValue.trim() : '';
                if (!collectionIndex) {
                    swal.showInputError('יש להזין מס\' הזמנה');
                    return false;
                }
                swal({ title: 'טוען הזמנה...' });
                $.ajax({
                    url: window.baseUrl + 'posApi/completedSingleOrder?collectionIndex=' + encodeURIComponent(collectionIndex),
                    method: 'GET',
                    headers: {
                        "authorization": UserToken
                    },
                    success: function (res) {
                        if (!res || res.status !== 'ok' || !res.data) {
                            swal({
                                title: 'הזמנה לא נמצאה',
                                text: 'לא נמצאה הזמנה שטופלה במלואה עבור מס\' הזמנה זה.',
                                type: 'info',
                                confirmButtonText: 'סגור'
                            });
                            return;
                        }
                        var order = res.data;
                        var html = '<div style="display:flex;align-items:center;justify-content:space-between;direction:ltr;padding:10px 0;">';
                        html += '<button type="button" id="printSingleBtn" data-orderid="' + (order.orderId || order.id) + '" style="margin:0 0 0 10px;background:#1976d2;color:#fff;border:none;border-radius:3px;padding:4px 12px;cursor:pointer;font-size:15px;">הדפס</button>';
                        html += '<span style="font-family:monospace;font-size:18px;">' + (order.orderId || order.id) + '</span>';
                        html += '</div>';
                        swal({
                            title: 'הזמנה להדפסה',
                            html: true,
                            text: html,
                            showConfirmButton: false,
                            showCancelButton: true,
                            cancelButtonText: 'סגור',
                            customClass: 'print-queue-popup'
                        });
                        setTimeout(function () {
                            $('#printSingleBtn').off('click').on('click', function () {
                                var orderId = $(this).data('orderid');
                                sendOrderToPrintQueue(orderId);
                            });
                        }, 100);
                    },
                    error: function () {
                        swal({
                            title: 'שגיאה',
                            text: 'שגיאה בשליפת ההזמנה מהשרת',
                            type: 'error',
                            confirmButtonText: 'סגור'
                        });
                    }
                });
            });

            // No manual injection - using SweetAlert's built-in input (prevents duplicate inputs)
        }

        // שליחת הזמנה לשרת
        function sendOrderToPrintQueue(orderId) {

            var userId = window.CurrentUserId || '';
            var type = 'order';
            swal({
                title: 'שולח להדפסה...',
                text: '',
                showConfirmButton: false,
                allowOutsideClick: false
            });
            $.ajax({
                url: `${window.baseUrl}posApi/approvePrintQueue`,
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    "authorization": UserToken
                },
                data: JSON.stringify({ type: type, docId: orderId }),
                success: function (res) {
                    console.log('**res', res);

                    if (res.status === 'ok') {
                        swal({ title: 'ההדפסה אושרה', text: res.massege, type: 'success', timer: 1800, showConfirmButton: false });
                    } else {
                        swal({ title: 'שגיאה', text: res.massege || 'שגיאה בשליחה', type: 'error', timer: 2500, showConfirmButton: false });
                    }
                },
                error: function () {
                    swal({ title: 'שגיאה', text: 'שגיאה בשליחה לשרת', type: 'error', timer: 2500, showConfirmButton: false });
                }
            });
        }

        // פונקציות עבור האייקונים בטאב הזמנות

        // הדפסת הזמנה מהאייקון
        function printOrderFromIcon(element) {
            event.stopPropagation(); // עצירת התפשטות האירוע

            var orderId = $(element).data('order-id');
            if (!orderId && element.dataset) {
                orderId = element.dataset.orderId;
            }

            // אם אין orderId מהאלמנט, ננסה להשתמש ב-window.OrderId
            if (!orderId && window.OrderId && window.OrderId !== "") {
                orderId = window.OrderId;
            }

            sendOrderToPrintQueue(orderId);
        }

        // הדפסת מדבקות
        function printStickersFromIcon(element) {
            event.stopPropagation(); // עצירת התפשטות האירוע
            var orderId = $(element).data('order-id');
            if (!orderId) {
                swal({ title: 'שגיאה', text: 'לא נמצא מזהה הזמנה', type: 'error', timer: 2000, showConfirmButton: false });
                return;
            }

            var userId = window.CurrentUserId || '';
            var type = 'orderStickers';
            swal({
                title: 'שולח מדבקות להדפסה...',
                text: '',
                showConfirmButton: false,
                allowOutsideClick: false
            });
            $.ajax({
                url: `${window.baseUrl}posApi/approvePrintQueue`,
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    "authorization": UserToken
                },
                data: JSON.stringify({ type: type, docId: orderId }),
                success: function (res) {
                    if (res.status === 'ok') {
                        swal({ title: 'הדפסת המדבקות אושרה', text: res.message, type: 'success', timer: 1800, showConfirmButton: false });
                    } else {
                        swal({ title: 'שגיאה', text: res.message || 'שגיאה בשליחה', type: 'error', timer: 2500, showConfirmButton: false });
                    }
                },
                error: function () {
                    swal({ title: 'שגיאה', text: 'שגיאה בשליחה לשרת', type: 'error', timer: 2500, showConfirmButton: false });
                }
            });
        }

        // סגירת הזמנה
        function closeOrderFromIcon(element) {
            event.stopPropagation(); // עצירת התפשטות האירוע

            var orderId = $(element).data('order-id');
            if (!orderId && element.dataset) {
                orderId = element.dataset.orderId;
            }

            // אם אין orderId מהאלמנט, ננסה להשתמש ב-window.OrderId
            if (!orderId && window.OrderId && window.OrderId !== "") {
                orderId = window.OrderId;
            }

            var userId = window.CurrentUserId || '';

            // שאלת אישור לפני סגירת ההזמנה
            swal({
                title: 'אישור סגירת הזמנה',
                text: 'האם אתה בטוח שברצונך לסגור את ההזמנה?',
                type: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff5722',
                confirmButtonText: 'אישור',
                cancelButtonText: 'ביטול',
                closeOnConfirm: false
            }, function (isConfirm) {
                if (isConfirm) {
                    // אם אישר - מתחילים את תהליך הסגירה
                    swal({
                        title: 'סוגר הזמנה...',
                        text: '',
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });

                    $.ajax({
                        url: `${window.baseUrl}posApi/closeOrder`,
                        method: 'POST',
                        contentType: 'application/json',
                        headers: {
                            "authorization": UserToken
                        },
                        data: JSON.stringify({ orderId: orderId }),
                        success: function (res) {
                            console.log('***', res);

                            if (res.status === 'ok') {
                                swal({ title: 'ההזמנה נסגרה', text: res.massege, type: 'success', timer: 1800, showConfirmButton: false });
                                // רענון הרשימה
                                setTimeout(function () {
                                    ShowTab(1);
                                }, 1000);
                            } else {
                                swal({ title: 'שגיאה', text: res.massege || 'שגיאה בסגירת ההזמנה', type: 'error', timer: 2500, showConfirmButton: false });
                            }
                        },
                        error: function () {
                            swal({ title: 'שגיאה', text: 'שגיאה בשליחה לשרת', type: 'error', timer: 2500, showConfirmButton: false });
                        }
                    });
                }
            });
        }
        // קבלת הזמנות להצגה בטאב 1 עם הפרדה לפי סטטוס
        // משתנה גלובלי לספירת ההזמנות שנאספו
        window.CollectionCounter = 0;
        // משתנה לשמירת מעקב על מספרי ההזמנות
        window.OrderNumbers = {};
        window.baseUrl = 'https://us-central1-kanfei-nesharim2.cloudfunctions.net/';
        // משתנה גלובלי לפילטר ההזמנות
        window.OrderFilter = 'new';

        // פונקציה ליצירת אנימציה של מספר איסוף
        function showCollectionAnimation(element, number) {
            // יצירת אלמנט האנימציה
            var animationElement = $('<div class="collection-animation" data-number="' + number + '">' + number + '</div>');

            // הוספת עיצוב לאלמנט האנימציה
            animationElement.css({
                'position': 'absolute',
                'left': '-15px', // הזזה יותר שמאלה כדי לא להסתיר את המספר הקיים
                'bottom': '50%',
                'transform': 'translateY(50%)',
                'background': '#4caf50',
                'color': 'white',
                'border-radius': '50%',
                'width': '25px',
                'height': '25px',
                'display': 'flex',
                'align-items': 'center',
                'justify-content': 'center',
                'font-weight': 'bold',
                'font-size': '12px',
                'z-index': '1000',
                'opacity': '1',
                'box-shadow': '0 2px 8px rgba(0,0,0,0.3)'
            });

            // הוספת האלמנט לשורת המוצר
            element.css('position', 'relative').append(animationElement);

            // אנימציה קלה של הופעה בלבד (ללא היעלמות)
            animationElement.animate({
                'left': '27.5px'
            }, 200);
        }

        // פונקציה להסרת אלמנט האנימציה
        function removeCollectionAnimation(element) {
            element.find('.collection-animation').remove();
        }

        // פונקציה לעדכון מספרי כל האלמנטים לאחר הסרה
        function updateAllOrderNumbers(ordersStatus1) {
            var counter = 1;
            window.OrderNumbers = {};

            // עדכון המספרים של כל ההזמנות הנבחרות
            for (var i = 0; i < ordersStatus1.length; i++) {
                var order = ordersStatus1[i];
                var id = order.id;

                if (window.SelectedOrders && window.SelectedOrders.indexOf(id) !== -1) {
                    window.OrderNumbers[id] = counter;

                    // מציאת האלמנט ועדכון המספר
                    var $element = $("#OrdersListStatus1 .order-row").eq(i);
                    var $animationElement = $element.find('.collection-animation');
                    if ($animationElement.length > 0) {
                        $animationElement.text(counter).attr('data-number', counter);
                    }
                    counter++;
                }
            }

            // עדכון המונה הגלובלי
            window.CollectionCounter = counter - 1;
        }

        // פונקציות עזר לבחירה מרובה (הגדרה גלובלית)
        function updateSelectedOrdersUI(ordersStatus1, ordersStatus2) {
            // עדכון עיצוב שורות בסטטוס 1
            $("#OrdersListStatus1 .order-row").each(function (idx) {
                var order = ordersStatus1[idx];
                if (order) {
                    var id = order.orderId || order.id;
                    if (window.SelectedOrders && window.SelectedOrders.indexOf(id) !== -1) {
                        $(this).css({ "background": "#e0f7fa", "border": "2.5px solid #009688" });
                    } else {
                        $(this).css({ "background": "#fffdfa", "border": "2px solid #e7e7e7" });
                    }
                }
            });
            // עדכון עיצוב שורות בסטטוס 2 (הזמנות בליקוט)
            $("#OrdersListStatus2 .order-row").each(function (idx) {
                var order = ordersStatus2 ? ordersStatus2[idx] : null;
                if (order) {
                    var id = order.orderId || order.id;
                    if (window.SelectedOrders && window.SelectedOrders.indexOf(id) !== -1) {
                        $(this).css({ "background": "#e0f7fa", "border": "2.5px solid #009688" });
                    } else {
                        $(this).css({ "background": "#F9F9F9", "border": "2px solid #d0d0d0" });
                    }
                }
            });
            // עדכון כפתור/טקסט בתחתית
            if (!window.SelectedOrders || window.SelectedOrders.length === 0) {
                $("#ApproveSelectedOrdersBarContent").html('<span style="color:#888;font-size:17px;">לחץ על שורה כדי לבחור</span>');
            } else {
                // חישוב סיכום פריטים ויחידות
                var totalUnits = 0;
                var totalQty = 0;
                var allOrders = (ordersStatus1 || []).concat(ordersStatus2 || []);

                for (var i = 0; i < window.SelectedOrders.length; i++) {
                    var selectedId = window.SelectedOrders[i];
                    for (var j = 0; j < allOrders.length; j++) {
                        var orderId = allOrders[j].orderId || allOrders[j].id;
                        if (orderId === selectedId) {
                            totalUnits += allOrders[j].totalItems || 0;
                            totalQty += allOrders[j].totalUnits || 0;
                            break;
                        }
                    }
                }

                $("#ApproveSelectedOrdersBarContent").html(
                    '<div style="display:flex;flex-direction:column;align-items:center;width:100%;gap:8px;">' +
                    '<div onclick="approveSelectedOrders()" style="display:inline-flex;align-items:center;justify-content:center;background:#8bc34a;font-weight:bold;color:#4a4a4a;cursor:pointer;padding:10px 18px;box-sizing:border-box;border-radius:3px;font-size:18px;width:100%;"><i class="fa-solid fa-check"></i><span style="padding:0 5px 0 0;">אשר ' + window.SelectedOrders.length + ' הזמנות</span></div>' +
                    '<div style="display:flex;align-items:center;justify-content:center;color:#333;font-weight:bold;font-size:14px;gap:15px;">' +
                    '<span>סך הכל: ' + totalUnits + ' פריטים, ' + totalQty + ' יחידות</span>' +
                    '</div>' +
                    '</div>'
                );
            }
        }

        function approveSelectedOrders() {
            if (!window.SelectedOrders || window.SelectedOrders.length === 0) return;
            var count = window.SelectedOrders ? window.SelectedOrders.length : 0;

            // יצירת מערך של orderId בלבד (בהתאם לאנדפוינט החדש)
            var ordersArr = window.SelectedOrders.slice(); // העתקה של המערך

            swal({
                type: "warning",
                title: "האם לאשר את כל ההזמנות שנבחרו?",
                text: 'נבחרו ' + count + ' הזמנות',
                showConfirmButton: true,
                confirmButtonText: 'אישור',
                confirmButtonColor: 'rgb(140, 212, 245)',
                showCancelButton: true,
                cancelButtonText: 'ביטול',
                allowOutsideClick: false,
                html: true
            }, function (res) {
                if (res == true) {
                    $.ajax({
                        type: "POST",
                        url: `${window.baseUrl}posApi/approveEmployeesToOrders`,
                        data: { ordersArr: ordersArr },
                        context: Text,
                        timeout: 60000,
                        headers: {
                            "authorization": UserToken
                        }
                    }).success(function (Response) {
                        if (Response.status == 'error') {
                            MySwal(Response.massege)
                            return false;
                        }
                        window.SelectedOrders = [];
                        MySwal(Response.massege, undefined, "success");
                    }).error(function () {
                        MySwal("שגיאה בקבלת נתונים. בדוק תקשורת");
                    });
                }
            });
            ShowTab(2);
        }
        var ListOrders = [];

        // פונקציה לטיפול בכפתורי פילטר ההזמנות
        function setOrderFilter(filterType) {
            // שמירת הפילטר במשתנה גלובלי
            window.OrderFilter = filterType;

            // איפוס כל הכפתורים למצב לא פעיל
            $("#filterAll, #filterMine, #filterNew").css({
                "background": "transparent",
                "color": "#666"
            });

            // הפעלת הכפתור הנבחר
            switch (filterType) {
                case 'all':
                    $("#filterAll").css({
                        "background": "#009688",
                        "color": "white"
                    });
                    break;
                case 'mine':
                    $("#filterMine").css({
                        "background": "#009688",
                        "color": "white"
                    });
                    break;
                case 'new':
                    $("#filterNew").css({
                        "background": "#009688",
                        "color": "white"
                    });
                    break;
            }

            // קריאה מחדש לשרת עם הפילטר החדש
            getOrders();
        }

        // פונקציה לטיפול בלחיצה על ריבוע עובד
        function handleEmployeeBoxClick(element) {
            event.stopPropagation(); // עצירת התפשטות האירוע

            var $element = $(element);

            // בדיקה אם זה ריבוע של המשתמש הנוכחי (בצבע ורוד)
            var isCurrentUserBox = $element.css('background-color').includes('248, 230, 255') ||
                $element.css('background').includes('#f8e6ff') ||
                $element.css('cursor') === 'pointer';


            if (!isCurrentUserBox) {
                return; // אם זה לא של המשתמש הנוכחי, לא עושים כלום
            }

            var orderId = $element.data('order-id');

            swal({
                type: "warning",
                title: "בטל שיוך להזמנה?",
                text: "האם אתה בטוח שברצונך לבטל את השיוך שלך להזמנה זו?",
                showConfirmButton: true,
                confirmButtonText: 'בטל שיוך',
                confirmButtonColor: '#f44336',
                showCancelButton: true,
                cancelButtonText: 'ביטול',
                allowOutsideClick: false,
                html: true
            }, function (res) {
                if (res == true) {
                    // קריאה לשרת לביטול השיוך
                    console.log('ביטול שיוך להזמנה:', orderId);

                    $.ajax({
                        type: "POST",
                        url: `${window.baseUrl}posApi/removeEmployeeToOrder`,
                        data: { orderId: orderId },
                        context: Text,
                        timeout: 30000,
                        headers: {
                            "authorization": UserToken
                        }
                    }).success(function (Response) {
                        if (Response.status == 'error') {
                            MySwal(Response.massege);
                            return false;
                        }

                        // הודעת הצלחה
                        MySwal(Response.massege, undefined, "success");

                        // רענון הרשימה
                        setTimeout(function () {
                            getOrders();
                        }, 1000);

                    }).error(function () {
                        MySwal("שגיאה בביטול השיוך. בדוק תקשורת");
                    });
                }
            });
        }

        // פונקציה ליצירת שורת הזמנה לאיסוף (Tab 1)

        function getOrders() {
            // איפוס בחירות בטאב 1 בכל רענון
            window.SelectedOrders = [];
            // איפוס מונה האיסוף ומעקב המספרים
            window.CollectionCounter = 0;
            window.OrderNumbers = {};

            $.ajax({
                url: `${window.baseUrl}posApi/employeesToOrders`,
                context: Text,
                timeout: 16000,
                headers: {
                    "authorization": UserToken,
                    "filterParams": window.OrderFilter || 'all' // הוספת הפילטר לכותרות הבקשה
                }
            }).success(function (Response) {
                if (Response.status == 'error') {
                    MySwal(Response.massege)
                    return false;
                }
                ListOrders = Response.data;
                console.log('**ListOrders**', ListOrders);


                // הזמנות שעדיין לא נתפסו (employeeObjects ריק) - יופיעו מעל הקו
                var ordersStatus1 = ListOrders.filter(function (o) { return !o.employeeObjects || o.employeeObjects.length === 0; });
                // הזמנות שכבר נתפסו (employeeObjects לא ריק) - יופיעו מתחת לקו  
                var ordersStatus2 = ListOrders.filter(function (o) { return o.employeeObjects && o.employeeObjects.length > 0; });

                // חישוב המונה הגלובלי לפי הערך הגבוה ביותר ב-cartIndex
                var maxCartIndex = 0;
                for (var i = 0; i < ordersStatus2.length; i++) {
                    if (ordersStatus2[i].cartIndex && ordersStatus2[i].cartIndex > maxCartIndex) {
                        maxCartIndex = ordersStatus2[i].cartIndex;
                    }
                }
                window.CollectionCounter = maxCartIndex;

                // מערך בחירות
                window.SelectedOrders = window.SelectedOrders || [];

                var html = '';
                html += '<div style="padding: 0 10px 70px;">';
                // html += '<div style="text-align: center; font-size: 18px; font-weight: bold; color: #009688; margin: 10px 0;">רשימת הזמנות לאיסוף</div>';
                html += '<div id="OrdersListStatus1">';
                if (ordersStatus1.length === 0 && window.OrderFilter === "all") {
                    html += '<div style="text-align:center; color:#bdbdbd; font-size:15px; padding:10px 0;">אין הזמנות ממתינות</div>';
                } else {
                    for (var i = 0; i < ordersStatus1.length; i++) {
                        html += renderOrderRow(ordersStatus1[i], i, 1);
                    }
                }
                html += '</div>';

                // הצגת קו מפריד וחלק "הזמנות בליקוט" רק אם:
                // 1. יש הזמנות בליקוט (ordersStatus2.length > 0), או
                // 2. הפילטר הוא "שלי" או "הכל" (כי אז רוצים לראות את החלוקה)
                var currentFilter = window.OrderFilter || 'new';
                var shouldShowStatus2Section = ordersStatus2.length > 0 || (currentFilter === 'mine' || currentFilter === 'all');

                if (shouldShowStatus2Section) {
                    currentFilter === 'all' &&
                        (html += '<div style="margin: 18px 0 10px 0; display: flex; align-items: center;">'
                            + '<hr style="flex:1; border:none; border-top:1.5px solid #e0e0e0; margin:0 10px;">'
                            + '<span style="color:#888; font-size:15px; background:#fff; padding:0 10px;">הזמנות בליקוט</span>'
                            + '<hr style="flex:1; border:none; border-top:1.5px solid #e0e0e0; margin:0 10px;">'
                            + '</div>');
                    html += '<div id="OrdersListStatus2">';
                    if (ordersStatus2.length === 0) {
                        html += '<div style="text-align:center; color:#bdbdbd; font-size:15px; padding:10px 0;">אין הזמנות בליקוט</div>';
                    } else {
                        for (var j = 0; j < ordersStatus2.length; j++) {
                            html += renderOrderRow(ordersStatus2[j], j, 2);
                        }
                    }
                    html += '</div>';
                } else {
                    // אם לא מציגים את החלק של הזמנות בליקוט, עדיין צריך את הdiv עם id
                    html += '<div id="OrdersListStatus2" style="display: none;"></div>';
                }
                html += '</div>';

                // אלמנט קבוע בתחתית TAB
                html += '<div id="ApproveSelectedOrdersBar" style="position:fixed;bottom:0;left:0;width:100%;z-index:10;">'
                    + '<div style="max-width:500px;width:95%;margin:auto;position:relative;background:#ffffff;padding:8px 0;box-sizing:border-box;border-top:2px solid #cbcbcb;text-align:center;">'
                    + '<div id="ApproveSelectedOrdersBarContent"></div>'
                    + '</div>'
                    + '</div>';

                $("#Tab1List").html(html);


                // סימון שורה בלחיצה לסטטוס 1
                $("#OrdersListStatus1 .order-row").off("click").on("click", function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    var $this = $(this);
                    var idx = $("#OrdersListStatus1 .order-row").index($this);
                    var order = ordersStatus1[idx];

                    if (!order) {
                        console.error('Order not found at index:', idx, 'in status 1');
                        return;
                    }

                    var id = order.orderId || order.id;

                    if (window.SelectedOrders.indexOf(id) === -1) {
                        window.SelectedOrders.push(id);
                        window.CollectionCounter++;
                        window.OrderNumbers[id] = window.CollectionCounter;
                    } else {
                        window.SelectedOrders = window.SelectedOrders.filter(function (oid) { return oid !== id });
                        delete window.OrderNumbers[id];
                    }

                    updateSelectedOrdersUI(ordersStatus1, ordersStatus2);
                });

                // סימון שורה בלחיצה לסטטוס 2 - מבוטל כי הזמנות בליקוט לא ניתנות ללחיצה
                $("#OrdersListStatus2 .order-row").off("click").on("click", function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // מניעת לחיצה על הזמנות שכבר בליקוט
                    return false;
                });

                // טיפול בלחיצה על ריבוע העובד - מטופל עכשיו ב-onclick

                // עדכון UI ראשוני
                updateSelectedOrdersUI(ordersStatus1, ordersStatus2);
            }).error(function () {
                MySwal("שגיאה בקבלת נתונים. בדוק תקשורת");
            });
        }

        function renderOrderRow(prod, idx, status) {
            var html = '';

            // קביעת סטטוס בהתאם למערך employeeObjects
            var isAssigned = prod.employeeObjects && Array.isArray(prod.employeeObjects) && prod.employeeObjects.length > 0;

            // בדיקה אם ההזמנה משוייכת למשתמש הנוכחי
            var isAssignedToCurrentUser = false;
            if (isAssigned && UserName) {
                for (var empIndex = 0; empIndex < prod.employeeObjects.length; empIndex++) {
                    var employeeName = prod.employeeObjects[empIndex].name || prod.employeeObjects[empIndex].employeeName || prod.employeeObjects[empIndex];
                    if (employeeName === UserName) {
                        isAssignedToCurrentUser = true;
                        break;
                    }
                }
            }

            // נוסיף class נוסף לזיהוי בחירה
            var backgroundColor = isAssigned ? '#F9F9F9' : '#fffdfa'; // רקע רגיל לכל ההזמנות
            var borderColor = isAssigned ? '#d0d0d0' : '#e7e7e7';
            var sectionBackgroundColor = isAssigned ? '#C5C5C5' : '#4db6ac'; // צבע רגיל לריבועי פריטים ויחידות
            var textOpacity = isAssigned ? '0.8' : '1';
            var cursorStyle = (status == 2) ? 'not-allowed' : 'pointer'; // אפשר לחיצה רגילה

            html += '<div class="order-row" data-collected="false" data-product-id="' + prod.id + '" style="text-align: right; position: relative; border-radius: 5px; margin: 5px auto; background: ' + backgroundColor + '; font-size: 18px; box-sizing: border-box; border: 2px solid ' + borderColor + '; overflow: visible; transition: background 0.2s, border 0.2s; opacity: ' + textOpacity + '; cursor: ' + cursorStyle + ';">';

            // שורת ההזמנה הראשית
            html += '<div style="display: flex; align-items: stretch; min-height: 50px;">';

            // צד ימין: כמות פריטים וכמות יחידות בריבועים
            html += '<div style="display: flex; gap: 2px; padding: 1px;">';
            // ריבוע פריטים
            var textColor = status == 2 ? 'white' : 'white'; // טקסט לבן לריבועים כהים
            var totalItemsValue = parseFloat(prod.totalItems || '0');
            var totalItemsDisplay = totalItemsValue % 1 === 0 ? totalItemsValue.toString() : totalItemsValue.toFixed(1);
            html += '<div style="background: ' + sectionBackgroundColor + '; color: ' + textColor + '; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 45px; border-radius: 4px; padding: 2px 1px; font-weight: bold;">';
            html += '<span style="font-size: 27px; font-weight: bold; line-height: 1;">' + totalItemsDisplay + '</span>';
            html += '<span style="font-size: 11px; margin-top: 1px;">פריטים</span>';
            html += '</div>';
            // ריבוע יחידות
            var totalUnitsValue = parseFloat(prod.totalUnits || '0');
            var totalUnitsDisplay = totalUnitsValue % 1 === 0 ? totalUnitsValue.toString() : totalUnitsValue.toFixed(1);
            html += '<div style="background: ' + sectionBackgroundColor + '; color: ' + textColor + '; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 45px; border-radius: 4px; padding: 2px 1px; font-weight: bold;">';
            html += '<span style="font-size: 27px; font-weight: bold; line-height: 1;">' + totalUnitsDisplay + '</span>';
            html += '<span style="font-size: 11px; margin-top: 1px;">יחידות</span>';
            html += '</div>';
            html += '</div>';

            // מרכז: מס' הזמנה, שם לקוח ושם העובד
            html += '<div style="flex: 1; padding: 0px 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; word-wrap: break-word; min-height: 50px;">';

            // חלק עליון (אינדקס ושם לקוח) - 50% מהגובה
            html += '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 22px; width: 100%;">';
            html += '<div style="font-size: 14px; color: #333; font-weight: bold;">' + (prod.order ? prod.order.collectionIndex : prod.orderId || '') + '</div>';
            html += '<div style="font-size: 12px; color: #333;  text-overflow: ellipsis; overflow: hidden; white-space: nowrap; width: 80px;">' + (prod.order.fullName || '') + '</div>';
            html += '</div>';

            if (isAssigned && prod.employeeObjects && prod.employeeObjects.length > 0) {
                // קו מפריד
                html += '<div style="width: 80%; height: 1px; background: #e0e0e0; "></div>';

                // חלק תחתון (שם העובד) - 50% מהגובה
                html += '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 25px; width: 100%;">';
                for (var empIndex = 0; empIndex < prod.employeeObjects.length; empIndex++) {
                    var employeeName = prod.employeeObjects[empIndex].name || prod.employeeObjects[empIndex].employeeName || prod.employeeObjects[empIndex];
                    if (employeeName) {
                        html += '<div style="font-size: 12px; color: #666;">' + employeeName + '</div>';
                    }
                }
                html += '</div>';
            }

            html += '</div>';

            // צד שמאל: אייקונים לפעולות - עיצוב נקי ומסודר
            html += '<div style="display: flex; flex-direction: column; gap: 2px; margin: 1px 0 1px 1px; width: 60px; height: 60px;">';

            // שורה עליונה של אייקונים
            html += '<div style="display: flex; gap: 2px; height: 28px;">';

            // אייקון ביטול שיוך או פח אפור
            if (isAssigned && isAssignedToCurrentUser) {
                // פח אדום פעיל - ביטול שיוך
                html += '<div class="action-icon unassign-icon" data-order-id="' + (prod.orderId || prod.id) + '" onclick="handleEmployeeBoxClick(this)" style="background: #f44336; color: white; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-size: 11px; width: 28px; height: 28px;" title="בטל שיוך">';
                html += '<i class="fa-solid fa-trash"></i>';
                html += '</div>';
            } else {
                // פח אפור לא פעיל
                html += '<div style="background: #bdbdbd; color: #757575; display: flex; align-items: center; justify-content: center; border-radius: 3px; font-size: 11px; width: 28px; height: 28px;" title="ביטול שיוך לא זמין">';
                html += '<i class="fa-solid fa-trash"></i>';
                html += '</div>';
            }

            // אייקון הדפסת מדבקות
            html += '<div class="action-icon print-labels-icon" data-order-id="' + (prod.orderId || prod.id) + '" onclick="printStickersFromIcon(this)" style="background: #2196f3; color: white; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-size: 11px; width: 28px; height: 28px;" title="הדפסת מדבקות">';
            html += '<i class="fa-solid fa-tags"></i>';
            html += '</div>';

            html += '</div>'; // סגירת שורה עליונה

            // שורה תחתונה של אייקונים
            html += '<div style="display: flex; gap: 2px; height: 28px;">';

            // אייקון סגירת הזמנה - הלוגיקה המתוקנת:
            // 1. הזמנות חדשות (לא משוייכות) - אפור ולא לחיץ
            // 2. הזמנות משוייכות לעובד אחר + עובד פשוט - אפור ולא לחיץ
            // 3. הזמנות משוייכות לעובד אחר + בכיר - כתום ולחיץ
            // 4. הזמנות משוייכות למשתמש הנוכחי - כתום ולחיץ

            var canCloseThisOrder = false;

            if (!isAssigned) {
                // הזמנה חדשה - לא ניתן לסגור
                canCloseThisOrder = false;
            } else if (isAssignedToCurrentUser) {
                // הזמנה משוייכת למשתמש הנוכחי - ניתן לסגור
                canCloseThisOrder = true;
            } else if (Role == 1) {
                // הזמנה משוייכת לעובד אחר אבל אני בכיר - ניתן לסגור
                canCloseThisOrder = true;
            } else {
                // הזמנה משוייכת לעובד אחר ואני עובד פשוט - לא ניתן לסגור
                canCloseThisOrder = false;
            }

            if (canCloseThisOrder) {
                html += '<div class="action-icon close-order-icon" data-order-id="' + (prod.orderId || prod.id) + '" onclick="closeOrderFromIcon(this)" style="background: #ff9800; color: white; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-size: 11px; width: 28px; height: 28px;" title="סגירת הזמנה">';
                html += '<i class="fa-solid fa-check-circle"></i>';
                html += '</div>';
            } else {
                html += '<div style="background: #bdbdbd; color: #757575; display: flex; align-items: center; justify-content: center; border-radius: 3px; font-size: 11px; width: 28px; height: 28px;" title="אין אפשרות לסגור הזמנה זו">';
                html += '<i class="fa-solid fa-check-circle"></i>';
                html += '</div>';
            }

            // אייקון הדפסת הזמנה
            // html += '<div class="action-icon print-order-icon" data-order-id="' + (prod.orderId || prod.id) + '" onclick="printOrderFromIcon(this)" style="background: #4caf50; color: white; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-size: 11px; width: 28px; height: 28px;" title="הדפסת הזמנה">';
            // html += '<i class="fa-solid fa-print"></i>';
            // html += '</div>';

            html += '</div>'; // סגירת שורה תחתונה

            html += '</div>'; // סגירת קונטיינר האייקונים

            // אייקון מעבר לליקוט לעובד בכיר - נפרד ונקי
            if (Role == 1 || isAssigned) {
                html += '<div class="action-icon go-to-collection-icon" data-order-id="' + (prod.orderId || prod.id) + '" onclick="goToCollectionFromOrder(this)" style="background: #9c27b0; color: white; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-size: 14px; width: 30px; height: 60px; margin-left: 2px;" title="עבור לליקוט הזמנה">';
                html += '<i class="fa-solid fa-arrow-left"></i>';
                html += '</div>';
            }

            html += '</div>'; // סגירת שורת ההזמנה הראשית

            // חלק הקטגוריות בתחתית השורה
            var hasNotes = (prod.notes && Array.isArray(prod.notes) && prod.notes.length > 0);
            if (hasNotes) {
                html += '<div style="width:100%;border-top:1px solid #e0e0e0;margin-top:0px;padding-top:1px;display:flex;flex-wrap:wrap;gap:6px 8px;">';
                // מערך קטגוריות (notes)
                for (var n = 0; n < prod.notes.length; n++) {
                    var noteStr = prod.notes[n];
                    if (noteStr && noteStr.trim() !== "") {
                        html += '<div style="display:inline-block;min-width:32px;max-width:100%;background:' + sectionBackgroundColor + ';color:#fff;font-weight:bold;padding:5px 13px;border-radius:50px;font-size:13px;margin-bottom:2px;box-shadow:0 1px 2px #0001;white-space:normal;word-break:break-word;text-align:center;">' + noteStr + '</div>';
                    }
                }
                html += '</div>';
            }

            html += '</div>'; // סגירת div הכללי של ההזמנה
            return html;
        }

        // פונקציה ליצירת שורת מוצר לפיזור (Tab 2) - עיצוב חדש עם אייקון ארגז ומקום לקוביות
        function renderOrderProductRow(prod, idx, isCompleted) {
            console.log(prod);

            isCompleted = isCompleted || false;

            var html = '';
            // קונטיינר עליון שמכיל את השורה והקוביות
            var containerStyle = 'margin: 5px auto; border-radius: 5px; transition: all 0.2s;';
            if (isCompleted) {
                containerStyle += ' opacity: 0.8;'; // שקיפות קלה למוצרים מושלמים
            }
            html += '<div class="product-container" data-product-id="' + prod.id + '" data-completed="' + isCompleted + '" style="' + containerStyle + '">';

            // דיב עוטף עם flex-direction: column
            html += '<div style="display: flex; flex-direction: column;">';

            // השורה עצמה
            html += '<div class="order-product-row" style="display: flex; align-items: stretch; text-align: right; position: relative; border-radius: ' + (prod.note ? '5px 5px 0 0' : '5px') + '; background: #f8faff; font-size: 18px; box-sizing: border-box; border: 2px solid #e7e7e7; ' + (prod.note ? 'border-bottom: none;' : '') + ' overflow: visible; min-height: 40px; transition: background 0.2s, border 0.2s; cursor: pointer;">';
            html += '<div style="background: #1976d2; color: white; display: flex; align-items: center; justify-content: center; min-width: 45px; font-weight: bold; font-size: 20px; position: relative;">';
            html += '<span style="font-size: 20px; font-weight: bold; padding: 0 2px;">' + (prod.collectionGroupOrder || '') + '</span>';
            html += '<i class="fa-solid fa-box-open" style="font-size: 15px; position: absolute; top: 1px; left: 50%; transform: translateX(-50%); opacity: 0.8;"></i>';
            html += '</div>';
            html += '<div style="flex: 1; padding: 5px 8px; display: flex; align-items: center; word-wrap: break-word; min-height: 40px;">';
            html += '<div style="font-size: 18px; color: #666;">' + (prod.productName || '') + '</div>';
            html += '</div>';

            // הוספת ריבוע cartIndex אם קיים
            if (prod.cartIndex) {
                html += '<div style="background: #ff9800; color: white; display: flex; align-items: center; justify-content: center; min-width: 45px; font-weight: bold; font-size: 20px; position: relative;">';
                html += '<span style="font-size: 20px; font-weight: bold; padding: 0 2px;">' + prod.cartIndex + '</span>';
                html += '</div>';
            }

            html += '<div style="background: #1976d2; color: white; display: flex; align-items: center; justify-content: center; min-width: 45px; font-weight: bold; font-size: 25px; position: relative;">';
            html += '<span style="position: relative; top: -3px; padding: 0 2px;">' + (prod.quantityOrWeight || '') + '</span>';
            html += '<span style="font-size: 10px; position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); opacity: 0.8;">יח&#39;</span>';
            html += '</div>';
            html += '</div>'; // סגירת השורה העיקרית

            // הוספת הערה אם קיימת - כעת מתחת לשורה העיקרית
            if (prod.note && prod.note.trim() !== "") {
                html += '<div style="background: #fff3e0; padding: 8px 12px; border: 2px solid #e7e7e7; border-top: none; font-size: 14px; color: #e65100; border-radius: 0 0 5px 5px;">';
                html += '<i class="fa-solid fa-comment" style="margin-left: 5px;"></i>' + prod.note.trim();
                html += '</div>';
            }

            html += '</div>'; // סגירת הדיב העוטף

            // מקום לקוביות - בתחילה מוסתר
            html += '<div class="cubes-area" style="display: none;"></div>';

            html += '</div>'; // סגירת הקונטיינר
            return html;
        }

        // פונקציה למעבר לטאב ליקוט עם מס' הזמנה
        function goToCollectionFromOrder(element) {
            // עצירת התפשטות האירוע
            event.stopPropagation();

            // קבלת מס' ההזמנה מהאלמנט
            var orderId = $(element).data('order-id');

            // ניסיון לקבל את ה-ID בדרך אחרת
            if (!orderId) {
                orderId = element.dataset.orderId;
            }

            if (orderId) {
                // שמירת מס' ההזמנה במשתנה הגלובלי
                window.OrderId = orderId;

                // מעבר לטאב ליקוט (טאב 2)
                ShowTab(2);
            } else {
                console.error('No orderId found in element:', element);
            }
        }

        // משתנה גלובלי לסוג התצוגה
        window.ViewMode = 'order'; // 'order' או 'product'

        // משתנה גלובלי לטאב 3 (משלוחים)
        window.ShippingViewMode = 'orders'; // 'orders' או 'products'

        // קבלת מוצרים לפיזור והצגה בטאב 2
        function getOrderProducts() {
            // איפוס בחירות בטאב 2 בכל רענון - כעת מערך של קוביות
            window.ProductCubes = {};
            window.ExpandedProducts = {};
            window.OriginalServerData = {}; // נתוני השרת המקוריים
            window.ModifiedProducts = {}; // מוצרים שעברו שינוי ידני
            window.UserChanges = {}; // שינויים ספציפיים שהעובד עשה

            // בניית URL עם פרמטרים
            var url = `${window.baseUrl}posApi/orderProducts?viewMode=` + window.ViewMode;
            if (OrderId && OrderId !== "") {
                url += '&orderId=' + OrderId;
            }
            console.log('****URL: ', url);


            $.ajax({
                url: url,
                context: Text,
                timeout: 16000,
                headers: {
                    "authorization": UserToken
                }
            }).success(function (Response) {
                if (Response.status == 'error') {
                    MySwal(Response.massege)
                    return false;
                }
                console.log('*** op: ', Response.data);

                var orderProducts = Response.data || [];

                // הפרדת מוצרים לפי מצב טיפול
                var productsInProgress = orderProducts.filter(function (prod) {
                    return !isProductFullyProcessedByServer(prod);
                });
                var productsCompleted = orderProducts.filter(function (prod) {
                    return isProductFullyProcessedByServer(prod);
                });

                // שמירת המערכים המופרדים למשתנים גלובליים לשימוש בלחיצות
                window.CurrentProductsInProgress = productsInProgress;
                window.CurrentProductsCompleted = productsCompleted;

                var html = '';
                html += '<div style="padding: 0 10px 70px;">';

                // הצגת כותרת עם מספר הזמנה אם יש
                var titleText = 'מוצרים לליקוט';
                // כותרת עם אייקונים
                html += '<div style="display: flex; align-items: center; justify-content: space-between; margin: 10px 0; padding: 0 10px;">';
                html += '<div style="width: 60px;"></div>'; // רווח שמאלי לאייקונים
                // כותרת במרכז
                html += '<div style="flex-grow: 1; text-align: center; font-size: 18px; font-weight: bold; color: #009688;">' + titleText + '</div>';

                // אייקונים בצד שמאל (אם יש OrderId)
                html += '<div style="display: flex; gap: 5px; margin-right: 10px;">';
                // אייקון סגירה
                html += '<div onclick="closeOrderFromIcon({dataset:{orderId:window.OrderId}})" style="display:flex; align-items:center; justify-content:center; width:28px; height:28px; background:#ff9800; color:white; border-radius:3px; cursor:pointer;" title="סגירת הזמנה">';
                html += '<i class="fa-solid fa-check-circle" style="font-size:14px;"></i>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                // טוגל בוטון לבחירת סוג התצוגה
                html += '<div style="display: flex; justify-content: center; align-items: center; margin: 10px 0;">';
                html += '<div style="background: #f0f0f0; border-radius: 25px; padding: 3px; display: inline-flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">';
                html += '<button id="viewByOrder" onclick="toggleViewMode(\'order\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; color: ' + (window.ViewMode === 'order' ? 'white' : '#666') + '; background: ' + (window.ViewMode === 'order' ? '#009688' : 'transparent') + ';">לפי הזמנה</button>';
                html += '<button id="viewByProduct" onclick="toggleViewMode(\'product\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; color: ' + (window.ViewMode === 'product' ? 'white' : '#666') + '; background: ' + (window.ViewMode === 'product' ? '#009688' : 'transparent') + ';">לפי מוצר</button>';
                html += '</div>';
                html += '</div>';

                html += '<div style="display: flex; justify-content: center; align-items: center; padding: 0 0 10px 0;">';
                html += '</div>';

                html += '<div id="OrderProductsList">';

                // מוצרים בתהליך (למעלה)
                if (productsInProgress.length === 0) {
                    html += '<div style="text-align:center; color:#bdbdbd; font-size:15px; padding:10px 0;">אין מוצרים בתהליך</div>';
                } else {
                    for (var i = 0; i < productsInProgress.length; i++) {
                        html += renderOrderProductRow(productsInProgress[i], i, false);
                    }
                }

                // קו הפרדה אם יש מוצרים מושלמים
                if (productsCompleted.length > 0) {
                    html += '<div style="margin: 18px 0 10px 0; display: flex; align-items: center;">'
                        + '<hr style="flex:1; border:none; border-top:1.5px solid #e0e0e0; margin:0 10px;">'
                        + '<span style="color:#888; font-size:15px; background:#fff; padding:0 10px;">מוצרים מושלמים</span>'
                        + '<hr style="flex:1; border:none; border-top:1.5px solid #e0e0e0; margin:0 10px;">'
                        + '</div>';

                    // מוצרים מושלמים (למטה)
                    for (var j = 0; j < productsCompleted.length; j++) {
                        html += renderOrderProductRow(productsCompleted[j], j, true);
                    }
                }

                html += '</div>';
                html += '</div>';
                // פס קבוע בתחתית TAB
                html += '<div id="ApproveSelectedOrderProductsBar" style="position:fixed;bottom:0;left:0;width:100%;z-index:10;">'
                    + '<div style="max-width:500px;width:95%;margin:auto;position:relative;background:#ffffff;padding:8px 0;box-sizing:border-box;border-top:2px solid #cbcbcb;text-align:center;">'
                    + '<div id="ApproveSelectedOrderProductsBarContent"></div>'
                    + '</div>'
                    + '</div>';
                $("#Tab2List").html(html);

                // לוגיקת לחיצה חדשה על מוצרים - הצגת קוביות
                $("#OrderProductsList .order-product-row").off("click").on("click", function () {
                    var $productContainer = $(this).closest('.product-container');

                    // מציאת המוצר הנכון בהתבסס על אינדקס החדש
                    var allContainers = $("#OrderProductsList .product-container");
                    var containerIndex = allContainers.index($productContainer);

                    var prod;
                    var currentIndex = 0;

                    // חיפוש המוצר הנכון במערכים המופרדים
                    // תחילה במוצרים בתהליך
                    if (containerIndex < window.CurrentProductsInProgress.length) {
                        prod = window.CurrentProductsInProgress[containerIndex];
                    } else {
                        // אחר כך במוצרים מושלמים
                        var completedIndex = containerIndex - window.CurrentProductsInProgress.length;
                        if (completedIndex >= 0 && completedIndex < window.CurrentProductsCompleted.length) {
                            prod = window.CurrentProductsCompleted[completedIndex];
                        }
                    }

                    if (!prod) return; // לא נמצא מוצר

                    var id = prod.id;
                    var maxQuantity = parseFloat(prod.quantityOrWeight || 1);

                    // הגדרת product-id לקונטיינר אם לא קיים
                    if (!$productContainer.data('product-id')) {
                        $productContainer.data('product-id', id);
                    }

                    // סגירת כל המוצרים האחרים
                    closeAllProductsExcept(id);

                    // בדיקה אם המוצר כבר פתוח
                    var isCurrentlyExpanded = isProductExpanded(id);

                    if (!isCurrentlyExpanded) {
                        // פתיחת המוצר הנוכחי
                        window.ExpandedProducts[id] = true;

                        // אתחול קוביות על פי נתוני השרת - רק אם עדיין לא קיימות
                        if (!window.ProductCubes[id]) {
                            initializeCubesFromServerData(id, prod, maxQuantity);
                        }

                        // אם אין נתונים מהשרת ולא נבחרו קוביות בעבר, צבע קוביה 1 בירוק
                        if (!hasAnySelectedCubes(id)) {
                            var qtyCollected = parseInt(prod.qtyCollected || 0);
                            var qtyMissing = parseInt(prod.qtyMissing || 0);
                            if (qtyCollected === 0 && qtyMissing === 0) {
                                window.ProductCubes[id][1] = 'green';
                                // רישום השינוי כשינוי של העובד
                                recordUserChange(id, 1, 'white', 'green');
                                window.ModifiedProducts[id] = true;
                            }
                        }

                        // הוספת הקוביות באזור המיועד
                        var cubesContainer = createProductCubes(id, maxQuantity);
                        var $cubesArea = $productContainer.find('.cubes-area');
                        $cubesArea.empty().append(cubesContainer).show();

                        // עדכון עיצוב השורה
                        updateProductRowUI(id);
                    } else {
                        // אם המוצר כבר פתוח - סגירה של אזור הקוביות
                        window.ExpandedProducts[id] = false;
                        $productContainer.find('.cubes-area').hide().empty();
                    }
                });

                // עדכון UI ראשוני
                updateSelectedOrderProductsUI(window.CurrentProductsInProgress.concat(window.CurrentProductsCompleted));
            }).error(function () {
                MySwal("שגיאה בקבלת נתונים. בדוק תקשורת");
            });
        }

        function toggleViewMode(mode) {
            window.ViewMode = mode;
            ShowTab(2); // רענון הנתונים עם המצב החדש
        }
        // עדכון UI לבחירה עם קוביות - גרסה חדשה ללא פס התקדמות
        function updateSelectedOrderProductsUI(orderProducts) {
            $("#OrderProductsList .product-container").each(function (idx) {
                var prod = orderProducts[idx];
                var id = prod.id;
                var maxQuantity = parseFloat(prod.quantityOrWeight || 1);

                // הסרת קוביות ואינדיקטורים קיימים
                $(this).find('.cubes-area').hide().empty();
                $(this).find('.quantity-indicator').remove();

                // אתחול קוביות על פי נתוני השרת
                initializeCubesFromServerData(id, prod, maxQuantity);

                // בדיקה אם יש קוביות מסומנות ומצב אם כל הקוביות סומנו
                var hasSelectedCubes = hasAnySelectedCubes(id);
                var fullyMarked = allCubesMarked(id);

                // עדכון עיצוב שורת המוצר
                var $productRow = $(this).find('.order-product-row');
                if (!hasSelectedCubes) {
                    // אין סימונים - רקע רגיל
                    $productRow.css({
                        "background": "#f8faff",
                        "border": "2px solid #e7e7e7"
                    });
                } else if (fullyMarked) {
                    // כל הקוביות סומנו - רקע כחול (הושלם)
                    $productRow.css({
                        "background": "#e3f2fd",
                        "border": "2.5px solid #1976d2"
                    });
                } else {
                    // חלקי - יש קוביות לבנות - הצג אזהרה צהובה
                    $productRow.css({
                        "background": "#fff8e1", /* light warning yellow */
                        "border": "2px solid #f7bb4d" /* amber border */
                    });
                }

                // הוספת הקוביות אם המוצר נלחץ
                if (isProductExpanded(id)) {
                    var cubesContainer = createProductCubes(id, maxQuantity);
                    $(this).find('.cubes-area').empty().append(cubesContainer).show();
                }
            });
            // עדכון מונה בתחתית
            updateBottomCounter();
        }

        // משתנה גלובלי לשמירת מוצרים פתוחים
        window.ExpandedProducts = {};

        // משתנה גלובלי לשמירת מצבי הקוביות
        window.ProductCubes = {};

        // פונקציות עזר חדשות לקוביות
        function isProductExpanded(productId) {
            return window.ExpandedProducts[productId] === true;
        }

        function hasAnySelectedCubes(productId) {
            return window.ProductCubes[productId] &&
                Object.keys(window.ProductCubes[productId]).some(function (cubeNum) {
                    return window.ProductCubes[productId][cubeNum] !== 'white';
                });
        }

        // האם כל הקוביות של מוצר מסומןות (אין קוביות לבנות)
        function allCubesMarked(productId) {
            if (!window.ProductCubes[productId]) return false;
            var keys = Object.keys(window.ProductCubes[productId]);
            if (keys.length === 0) return false;
            for (var i = 0; i < keys.length; i++) {
                var val = window.ProductCubes[productId][keys[i]];
                if (val === 'white') return false;
            }
            return true;
        }

        function getSelectedProductsCount() {
            var count = 0;
            for (var productId in window.ProductCubes) {
                if (hasAnySelectedCubes(productId)) {
                    count++;
                }
            }
            return count;
        }

        function getTotalSelectedQuantity() {
            var total = 0;
            for (var productId in window.ProductCubes) {
                if (window.ProductCubes[productId]) {
                    for (var cubeNum in window.ProductCubes[productId]) {
                        if (window.ProductCubes[productId][cubeNum] === 'green') {
                            total++;
                        }
                    }
                }
            }
            return total;
        }

        function getTotalMissingQuantity() {
            var total = 0;
            for (var productId in window.ProductCubes) {
                if (window.ProductCubes[productId]) {
                    for (var cubeNum in window.ProductCubes[productId]) {
                        if (window.ProductCubes[productId][cubeNum] === 'red') {
                            total++;
                        }
                    }
                }
            }
            return total;
        }

        // ספירת מוצרים שהעובד שינה בפועל (לא כולל מה שהגיע מהשרת)
        function getUserModifiedProductsCount() {
            var count = 0;
            for (var productId in window.ProductCubes) {
                if (hasUserActuallyModifiedProduct(productId)) {
                    count++;
                }
            }
            return count;
        }

        // בדיקה אם העובד שינה מוצר בפועל (השוואה לנתונים המקוריים)
        function hasUserActuallyModifiedProduct(productId) {
            if (!window.ProductCubes[productId] || !window.OriginalServerData[productId]) {
                return false;
            }

            // חישוב המצב הנוכחי
            var currentGreen = 0;
            var currentRed = 0;

            for (var cubeNum in window.ProductCubes[productId]) {
                if (window.ProductCubes[productId][cubeNum] === 'green') {
                    currentGreen++;
                } else if (window.ProductCubes[productId][cubeNum] === 'red') {
                    currentRed++;
                }
            }

            // השוואה לנתונים המקוריים
            var originalData = window.OriginalServerData[productId];
            return (currentGreen !== originalData.qtyCollected || currentRed !== originalData.qtyMissing);
        }

        // ספירת יחידות שהעובד לקט (השוואה בין מצב נוכחי למקורי)
        function getUserCollectedQuantity() {
            var totalCollected = 0;
            for (var productId in window.ProductCubes) {
                if (window.ProductCubes[productId] && window.OriginalServerData[productId]) {
                    // חישוב המצב הנוכחי
                    var currentGreen = 0;
                    for (var cubeNum in window.ProductCubes[productId]) {
                        if (window.ProductCubes[productId][cubeNum] === 'green') {
                            currentGreen++;
                        }
                    }

                    // השוואה למצב המקורי
                    var originalGreen = window.OriginalServerData[productId].qtyCollected;
                    var difference = currentGreen - originalGreen;
                    if (difference > 0) {
                        totalCollected += difference;
                    }
                }
            }
            return totalCollected;
        }

        // ספירת יחידות שהעובד סימן כחסרות (השוואה בין מצב נוכחי למקורי)
        function getUserMissingQuantity() {
            var totalMissing = 0;
            for (var productId in window.ProductCubes) {
                if (window.ProductCubes[productId] && window.OriginalServerData[productId]) {
                    // חישוב המצב הנוכחי
                    var currentRed = 0;
                    for (var cubeNum in window.ProductCubes[productId]) {
                        if (window.ProductCubes[productId][cubeNum] === 'red') {
                            currentRed++;
                        }
                    }

                    // השוואה למצב המקורי
                    var originalRed = window.OriginalServerData[productId].qtyMissing;
                    var difference = currentRed - originalRed;
                    if (difference > 0) {
                        totalMissing += difference;
                    }
                }
            }
            return totalMissing;
        }

        function getMissingQuantity(productId) {
            var missing = 0;
            if (window.ProductCubes[productId]) {
                for (var cubeNum in window.ProductCubes[productId]) {
                    if (window.ProductCubes[productId][cubeNum] === 'red') {
                        missing++;
                    }
                }
            }
            return missing;
        }

        // בדיקה אם מוצר טופל במלואו על פי נתוני השרת
        function hasAnySelectedCubes(productId) {
            if (!window.ProductCubes[productId]) {
                return false;
            }

            for (var cubeNum in window.ProductCubes[productId]) {
                var color = window.ProductCubes[productId][cubeNum];
                if (color && color !== 'white') {
                    return true;
                }
            }
            return false;
        }

        // בדיקה אם מוצר שונה מהנתונים שהגיעו מהשרת
        function isProductModifiedFromServer(productId) {
            if (!window.ProductCubes[productId] || !window.OriginalServerData[productId]) {
                return false;
            }

            // חישוב הנתונים הנוכחיים
            var currentGreen = 0;
            var currentRed = 0;

            for (var cubeNum in window.ProductCubes[productId]) {
                if (window.ProductCubes[productId][cubeNum] === 'green') {
                    currentGreen++;
                } else if (window.ProductCubes[productId][cubeNum] === 'red') {
                    currentRed++;
                }
            }

            // השוואה לנתונים המקוריים מהשרת
            var originalData = window.OriginalServerData[productId];
            return (currentGreen !== originalData.qtyCollected || currentRed !== originalData.qtyMissing);
        }

        // בדיקה אם מוצר טופל במלואו על פי נתוני השרת
        function isProductFullyProcessedByServer(productData) {
            var qtyCollected = parseInt(productData.qtyCollected || 0);
            var qtyMissing = parseInt(productData.qtyMissing || 0);
            var maxQuantity = parseFloat(productData.quantityOrWeight || 1);

            // מוצר טופל במלואו אם סך הקוביות המטופלות (ירוק + אדום) שווה לכמות הכוללת
            return (qtyCollected + qtyMissing) >= maxQuantity;
        }

        // אתחול קוביות על פי נתוני השרת
        function initializeCubesFromServerData(productId, productData, maxQuantity) {
            // וידוא שיש מערך קוביות למוצר
            if (!window.ProductCubes[productId]) {
                window.ProductCubes[productId] = {};
            }

            var qtyCollected = 0;
            var qtyMissing = 0;

            // חילוץ נתונים מהשרת - עכשיו השדות ישירות על האובייקט
            qtyCollected = parseInt(productData.qtyCollected || 0);
            qtyMissing = parseInt(productData.qtyMissing || 0);

            // שמירת הנתונים המקוריים מהשרת
            window.OriginalServerData[productId] = {
                qtyCollected: qtyCollected,
                qtyMissing: qtyMissing
            };

            // אתחול כל הקוביות ללבן
            for (var i = 1; i <= maxQuantity; i++) {
                window.ProductCubes[productId][i] = 'white';
            }

            var cubeIndex = 1;

            // צביעת קוביות בירוק (נלקטו)
            for (var collected = 0; collected < qtyCollected && cubeIndex <= maxQuantity; collected++) {
                window.ProductCubes[productId][cubeIndex] = 'green';
                cubeIndex++;
            }

            // צביעת קוביות באדום (חסרים)
            for (var missing = 0; missing < qtyMissing && cubeIndex <= maxQuantity; missing++) {
                window.ProductCubes[productId][cubeIndex] = 'red';
                cubeIndex++;
            }
        }

        // יצירת קוביות עבור מוצר
        function createProductCubes(productId, maxQuantity) {
            var container = $('<div class="product-cubes" style="width: 100%; background: #f9f9f9; border-radius: 5px; border: 1px solid #ddd; clear: both; padding: 3px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; justify-items: center;"></div>');

            // וידוא שיש מערך קוביות למוצר
            if (!window.ProductCubes[productId]) {
                window.ProductCubes[productId] = {};
            }

            for (var i = 1; i <= maxQuantity; i++) {
                // יצירת קוביה
                var cube = $('<div class="product-cube" data-product-id="' + productId + '" data-cube-number="' + i + '" style="width: calc(100% - 2px); height: 35px; border: 2px solid #666; border-radius: 3px; text-align: center; line-height: 31px; font-weight: bold; cursor: pointer; font-size: 14px;">' + i + '</div>');

                // קביעת צבע ראשוני אם לא קיים
                if (!window.ProductCubes[productId][i]) {
                    window.ProductCubes[productId][i] = 'white';
                }

                // עדכון הצבע
                updateCubeColor(cube, window.ProductCubes[productId][i]);

                // הוספת אירוע לחיצה
                cube.on('click', function (e) {
                    e.stopPropagation();
                    var cubeProductId = $(this).data('product-id');
                    var cubeNumber = $(this).data('cube-number');
                    cycleCubeColor(cubeProductId, cubeNumber, $(this));
                });

                container.append(cube);
            }

            return container;
        }

        // עדכון צבע קוביה
        function updateCubeColor(cubeElement, color) {
            switch (color) {
                case 'white':
                    cubeElement.css({
                        'background-color': 'white',
                        'color': '#666'
                    });
                    break;
                case 'green':
                    cubeElement.css({
                        'background-color': '#4caf50',
                        'color': 'white'
                    });
                    break;
                case 'red':
                    cubeElement.css({
                        'background-color': '#f44336',
                        'color': 'white'
                    });
                    break;
            }
        }

        // מחזור צבעי קוביה (לבן -> ירוק -> אדום -> לבן)
        // רק עובד בכיר (role 1) יכול לצבוע באדום, עובד פשוט (role 2) רק ירוק ולבן
        function cycleCubeColor(productId, cubeNumber, cubeElement) {
            var currentColor = window.ProductCubes[productId][cubeNumber];
            var nextColor;

            switch (currentColor) {
                case 'white':
                    nextColor = 'green';
                    break;
                case 'green':
                    // רק עובד בכיר (Role == 1) יכול לעבור לאדום
                    if (Role == 1) {
                        nextColor = 'red';
                    } else {
                        // עובד פשוט (Role == 2) חוזר ללבן
                        nextColor = 'white';
                        // הצגת הודעה לעובד פשוט
                    }
                    break;
                case 'red':
                    nextColor = 'white';
                    break;
                default:
                    nextColor = 'white';
            }

            window.ProductCubes[productId][cubeNumber] = nextColor;
            updateCubeColor(cubeElement, nextColor);

            // רישום השינוי שהעובד עשה
            recordUserChange(productId, cubeNumber, currentColor, nextColor);

            // סימון שהמוצר עבר שינוי ידני
            window.ModifiedProducts[productId] = true;

            // עדכון UI של המוצר
            updateProductRowUI(productId);
        }

        // רישום השינוי שהעובד עשה
        function recordUserChange(productId, cubeNumber, fromColor, toColor) {
            if (!window.UserChanges[productId]) {
                window.UserChanges[productId] = [];
            }

            // רישום השינוי
            window.UserChanges[productId].push({
                cubeNumber: cubeNumber,
                fromColor: fromColor,
                toColor: toColor,
                timestamp: new Date()
            });
        }

        // עדכון עיצוב שורת מוצר ספציפי
        function updateProductRowUI(productId) {
            $("#OrderProductsList .product-container").each(function () {
                var rowProductId = $(this).data('product-id');
                if (rowProductId && rowProductId.toString() === productId.toString()) {
                    var hasSelectedCubes = hasAnySelectedCubes(productId);
                    var fullyMarked = allCubesMarked(productId);
                    var $productRow = $(this).find('.order-product-row');

                    if (!hasSelectedCubes) {
                        $productRow.css({
                            "background": "#f8faff",
                            "border": "2px solid #e7e7e7"
                        });
                    } else if (fullyMarked) {
                        $productRow.css({
                            "background": "#e3f2fd",
                            "border": "2.5px solid #1976d2"
                        });
                    } else {
                        $productRow.css({
                            "background": "#fff8e1",
                            "border": "2px solid #f7bb4d"
                        });
                    }
                }
            });

            // עדכון מונה בתחתית
            updateBottomCounter();
        }

        // עדכון מונה בתחתית
        function updateBottomCounter() {
            var totalSelectedProducts = getUserModifiedProductsCount(); // רק מוצרים שהעובד שינה
            var totalItemsCount = getUserCollectedQuantity(); // רק יחידות שהעובד לקט
            var totalMissingCount = getUserMissingQuantity(); // רק יחידות שהעובד סימן כחסרות

            if (totalSelectedProducts === 0) {
                $("#ApproveSelectedOrderProductsBarContent").html('<span style="color:#888;font-size:17px;">לחץ על שורה כדי לבחור</span>');
            } else {
                $("#ApproveSelectedOrderProductsBarContent").html(
                    '<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;width:100%;gap:5px;">' +
                    '<div onclick="approveSelectedOrderProducts()" style="display:inline-flex;align-items:center;justify-content:center;background:#8bc34a;font-weight:bold;color:#4a4a4a;cursor:pointer;padding:10px 18px;box-sizing:border-box;border-radius:3px;font-size:18px;width:100%;"><span>אשר מוצרים</span></div>' +
                    '<div style="display:flex;justify-content:center;align-items:center;width:100%;gap:15px;">' +
                    '<div style="display:flex;align-items:center;justify-content:center;color:#333;font-weight:bold;gap:5px;">' +
                    '<span style="font-size:20px;">' + totalSelectedProducts + '</span>' +
                    '<span style="font-size:14px;">מוצרים</span>' +
                    '</div>' +
                    (totalItemsCount > 0 ?
                        '<div style="display:flex;align-items:center;justify-content:center;color:#4caf50;font-weight:bold;gap:3px;">' +
                        '<span style="font-size:12px;">' + totalItemsCount + '</span>' +
                        '<span style="font-size:10px;">יח\' נלקטו</span>' +
                        '</div>' : '') +
                    (totalMissingCount > 0 ?
                        '<div style="display:flex;align-items:center;justify-content:center;color:#f44336;font-weight:bold;gap:3px;">' +
                        '<span style="font-size:12px;">' + totalMissingCount + '</span>' +
                        '<span style="font-size:10px;">יח\' חסר</span>' +
                        '</div>' : '') +
                    '</div>' +
                    '</div>'
                );
            }
        }

        // סגירת כל המוצרים פתוחים מלבד מוצר ספציפי
        function closeAllProductsExcept(exceptProductId) {
            for (var productId in window.ExpandedProducts) {
                if (productId !== exceptProductId.toString() && window.ExpandedProducts[productId]) {
                    window.ExpandedProducts[productId] = false;

                    // הסרת הקוביות מהתצוגה - כעת הן באזור המיועד
                    $("#OrderProductsList .product-container").each(function () {
                        var rowProductId = $(this).data('product-id');
                        if (rowProductId && rowProductId.toString() === productId) {
                            $(this).find('.cubes-area').hide().empty();
                        }
                    });
                }
            }
        }

        // פונקציית אישור מרובה - גרסה חדשה עם שדה חסרים
        function approveSelectedOrderProducts() {
            // יצירת מערך מוצרים לשליחה עם נתוני הקוביות
            var productsToApprove = [];

            for (var productId in window.ProductCubes) {
                // בדיקה אם המוצר שונה מהנתונים המקוריים מהשרת
                if (window.ModifiedProducts[productId]) {
                    var selectedQuantity = 0;
                    var missingQuantity = 0;

                    // ספירת קוביות ירוקות ואדומות
                    for (var cubeNum in window.ProductCubes[productId]) {
                        if (window.ProductCubes[productId][cubeNum] === 'green') {
                            selectedQuantity++;
                        } else if (window.ProductCubes[productId][cubeNum] === 'red') {
                            missingQuantity++;
                        }
                    }

                    // בדיקה אם המצב הנוכחי שונה מהמצב המקורי בשרת
                    var originalData = window.OriginalServerData[productId] || { qtyCollected: 0, qtyMissing: 0 };
                    if (selectedQuantity !== originalData.qtyCollected || missingQuantity !== originalData.qtyMissing) {
                        var productData = {
                            orderProductId: productId,
                            qtyCollected: selectedQuantity,
                            qtyMissing: missingQuantity,
                            userChanges: window.UserChanges[productId] || [] // השינויים שהעובד הנוכחי ביצע
                        };
                        productsToApprove.push(productData);
                    }
                }
            }

            if (productsToApprove.length === 0) {
                swal({
                    title: 'שגיאה',
                    text: 'יש לאשר את השינויים שנעשו',
                    type: 'error',
                    confirmButtonText: 'סגור'
                });
                return;
            }

            var totalQuantity = 0;
            var totalMissing = 0;

            // חישוב סכומים
            for (var i = 0; i < productsToApprove.length; i++) {
                totalQuantity += productsToApprove[i].qtyCollected;
                totalMissing += productsToApprove[i].qtyMissing;
            }

            // שימוש באותה ספירה כxxxxxxxxxxxxון
            var actualSelectedProductsCount = getUserModifiedProductsCount();
            var actualCollectedQuantity = getUserCollectedQuantity(); // רק מה שהעובד לקט בפועל
            var actualMissingQuantity = getUserMissingQuantity(); // רק מה שהעובד סימן כחסר בפועל

            var summaryText = 'נבחרו ' + actualSelectedProductsCount + ' מוצרים<br/>' +
                'נלקטו: ' + actualCollectedQuantity + ' יחידות<br/>' +
                (actualMissingQuantity > 0 ? 'חסרים: ' + actualMissingQuantity + ' יחידות' : '');


            swal({
                type: "warning",
                title: "האם לאשר את כל המוצרים שנבחרו?",
                text: summaryText,
                showConfirmButton: true,
                confirmButtonText: 'אישור',
                confirmButtonColor: 'rgb(56, 142, 60)',
                showCancelButton: true,
                cancelButtonText: 'ביטול',
                allowOutsideClick: false,
                html: true
            }, function (res) {
                if (res == true) {
                    $.ajax({
                        type: "POST",
                        url: `${window.baseUrl}posApi/approveOrderProducts`,
                        data: {
                            orderProducts: productsToApprove.map(product => ({
                                orderProductId: product.orderProductId,
                                qtyCollected: product.qtyCollected,
                                qtyMissing: product.qtyMissing
                            }))
                        },
                        context: Text,
                        timeout: 60000,
                        headers: {
                            "authorization": UserToken
                        }
                    }).success(function (Response) {
                        if (Response.status == 'error') {
                            MySwal(Response.massege)
                            return false;
                        }
                        // איפוס כל הנתונים
                        window.ProductCubes = {};
                        window.ExpandedProducts = {};
                        window.OriginalServerData = {};
                        window.ModifiedProducts = {};
                        window.UserChanges = {};
                        ShowTab(2);
                        MySwal(Response.massege, undefined, "success");
                    }).error(function () {
                        MySwal("שגיאה בקבלת נתונים. בדוק תקשורת");
                    });
                }
            });
        }
    </script>

    <style>
        * {
            font-family: 'Assistant', Arial, sans-serif;
        }

        @media screen and (max-width: 400px) {
            .DivTelText {
                width: 80% !important
            }
        }

        @media screen and (max-width: 500px) {
            #MainForm {
                margin-right: 0px !important
            }
        }

        .TextBox {
            -webkit-appearance: none;
            font-size: large;
            color: #3f475e;
            text-align: right;
            padding: 6px;
            border-color: #f7bb4d;
            border-style: solid;
            border-width: 2px;
            margin: 5px 5px;
            background-color: #FFFFFB;
            -webkit-box-sizing: border-box;
            border-radius: 5px;
            margin-top: 0;
            outline: none;
        }

        .RadioBtLbl {
            border-style: solid;
            border-color: #f7bb4d;
            border-width: 0px 0px 2px 0px;
            margin: 0px 10px;
            background-color: #FFFFFB;
            padding: 10px 2px 10px 10px;
            border-radius: 2px;
            -webkit-user-select: none;
            cursor: pointer;
            display: inline-block;
        }


        .SelectValLbl {
            border-style: solid;
            width: 90%;
            text-align-last: center;
            border-color: #f7bb4d;
            border-width: 0px 0px 2px 0px;
            font-size: large;
            color: #3f475e;
            margin: 0px 5px;
            background-color: #FFFFFB;
            padding: 7px 2px 10px 10px;
            border-radius: 2px;
            -webkit-user-select: none;
            cursor: pointer;
            display: inline-block;
            outline: none;
        }

        .Koteret {
            font-size: 22px;
            color: #ff6a00;
            font-weight: bold;
            text-align: right;
            padding-right: 27px;
            width: 90%;
            margin-top: 27px;
            margin-bottom: 10px;
            -webkit-user-select: none;
        }


        li {
            text-align: right;
            padding: 0px 0px 0px 25px;
            font-size: 17px;
            -webkit-user-select: none;
        }

        .checkbox {
            text-align: right;
            color: #2B3A63;
            padding: 0px 0px 0px 25px;
            font-size: 17px;
        }




        .Bt {
            -webkit-appearance: none;
            font-size: large;
            color: white;
            background-color: #38c232;
            text-align: center;
            padding: 12px 24px 12px 24px;
            border-color: #fff;
            border-style: solid;
            border-width: 2px;
            border-radius: 5px;
            cursor: pointer;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-overflow-scrolling: touch;
        }


        .modal-content {
            background-color: #fefefe;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            color: #808080;
            -webkit-box-shadow: 0px 0px 30px 0px rgba(50, 50, 50, 0.75);
            background-color: white;
            max-width: 500px;
            min-width: 200px;
            min-height: 250px;
            border-radius: 20px;
            text-align: center;
        }

        td {
            color: #296c8d;
            font-size: 20px;
            border: 1px solid #d7cece;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 15px;
            padding-bottom: 15px;
        }

        th {
            min-height: 500px;
            border: 1px solid #d7cece;
            color: #2B3A63;
            font-family: assistant, Arial;
        }

        .bordered td,
        .bordered th {
            border-left: 1px solid #ccc;
            border-top: 1px solid #ccc;
            padding: 5px;
        }

        .TableLightFont {
            font-weight: lighter;
            font-size: 14px;
        }


        table {
            border-collapse: collapse;
            border: 1px solid #d7cece;
            margin-right: auto;
            margin-left: auto;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .TableKoteret {
            text-align: center;
            padding-right: 20px;
            /*background-color: aliceblue;*/
            font-size: 25px;
            color: steelblue;
            /*lightslategrey*/
            font-weight: normal;
        }

        .fieldName {
            display: inline-block;
            text-align: right;
            width: 100%;
            font-size: medium;
            margin-right: 5px;
            color: #808080;
            -webkit-user-select: none;
            margin-right: 10px
        }

        /* Unified Navigation Bar Styles */
        #unifiedNav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #fff;
            border-bottom: 2px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #topBar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            min-height: 45px;
            background: #f5f5f5;
        }

        #leftActions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #centerInfo {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 10px;
        }

        #rightActions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 3px;
            background: #d9d9d9;
            color: #4a4a4a;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #c0c0c0;
        }

        #hamburgerMenu {
            background: #009688;
            color: white;
        }

        #hamburgerMenu:hover {
            background: #00796b;
        }

        #messagesBtn {
            position: relative;
        }

        #screenName {
            font-size: 16px;
            font-weight: bold;
            color: #009688;
        }

        #employeeName {
            font-size: 14px;
            color: #666;
        }

        /* Hamburger Menu Styles */
        #menuDropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border-bottom: 2px solid #e0e0e0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #menuDropdown.show {
            display: block;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item.active {
            background: #e0f2f1;
            border-right: 4px solid #009688;
        }

        .menu-item i {
            font-size: 20px;
            width: 30px;
            color: #009688;
        }

        .menu-item span {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        /* Selection Screen Card Styles - Clean System Design */
        .selection-card {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .selection-card:hover {
            background: #f5f5f5;
            border-color: #009688;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .selection-card i {
            font-size: 28px;
            width: 40px;
            color: #009688;
            margin-left: 15px;
        }

        .selection-card span {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }
    </style>

    <script>

        var Json = {
            "FormElements": [

            ],
            "TofesId": "3590",//
            "Version": "",
            "AllowChanges": false,
            "NeedSign": false,
            "PreData": false,
            "MosadId": "7013571", //0
            "MainLogo": "", // Files/Pic/000_logo.jpg
            "MainTitle": "ניהול הזמנות.",
            "SpecialCheck": "" //Phone: Date: MasavPayment "CreditCardPayment" //Zeout:Field7,Field10 //Mail:Field8 //CreditCardToken:Max //CheckDouble: //Bank: //CopyMail: //Tokef:Field8
        }


        var MasofId = ''
        var ClientId = '';
        var Zeout = '';
        var OldTofesId = '';
        var Demo = ''
        var SignData = ''
        var FixedWaiting = true;


        var CheckElementId = [];
        var CheckDbName = [];
        var CheckDBFree = [];


        var MainForm = '';
        $(document).ready(function () {
            $.ajaxSetup({ cache: false });

            FixedWaitingStyle()

            $(document).ajaxStart(function () {
                if (FixedWaiting == true) {
                    $('#FixedWaiting').show();
                }
            });
            $(document).ajaxStop(function (e) {
                $('#FixedWaiting').hide();
            });

            if (Json.MainLogo !== '') { $("#MainLogo").attr('src', Json.MainLogo); } else { $("#MainLogo").attr('src', 'https://images.matara.pro/ClientsImages/' + Json.MosadId + '.jpg?1'); }

            //AddClientLogin("1");

            if (GetURLParameter("Demo") == '1') Demo = "&Demo=1";
            MasofId = GetURLParameter("MasofId");
            ClientId = GetURLParameter("ClientId");
            Zeout = GetURLParameter("Zeout");

            if (GetURLParameter("Admin") == '1') $("#AdminBt").show();
            if (MasofId !== '') $("#BackToNedarim").show();
            if (Json.NeedSign == true) $("#SignAlert").show();

            for (var Element in Json.FormElements) {
                var JsonElement = Json.FormElements[Element]
                var Style = ""
                if (JsonElement.Style) Style = JsonElement.Style
                if (JsonElement.Type == "Koteret") {
                    MainForm += '<div class="Koteret" style="' + Style + '">' + JsonElement.Text + '</div>'
                } else {
                    var dir = "rtl"
                    var Bold = ""
                    if (JsonElement.Bold == true) Bold = "font-weight:bold"
                    if (JsonElement.Type == 'Tel') dir = "ltr"
                    var FieldName = JsonElement.fieldName
                    if (JsonElement.fieldNameShow !== undefined) FieldName = JsonElement.fieldNameShow
                    var Lbl = '<label for="' + JsonElement.ElementId + '" class="fieldName" style="' + Bold + ';' + Style + '">' + ((JsonElement.Mandatory == true) ? '<span id="Span_' + JsonElement.ElementId + '" style="color:indianred;">*</span>' : '<span id="Span_' + JsonElement.ElementId + '" style="color:indianred;display:none">*</span>') + FieldName + '</label><br>'
                    if (JsonElement.LblHide == true) Lbl = ''
                    if (JsonElement.Type == "Select") {
                        var DivData = '<div id="' + JsonElement.ElementId + 'Div"  style="width:' + JsonElement.Width + '%;display:inline-block;vertical-align:bottom;text-align:right;margin-top:10px;margin-right:20px;margin-bottom: 4px;' + Style + '">' + Lbl + '<select class="SelectValLbl"  id="' + JsonElement.ElementId + '">'
                        for (i = 0; i < JsonElement.SelectVal.split(",").length; i++) {
                            DivData += '<option value="' + JsonElement.SelectVal.split(",")[i].replace(/"/g, '&quot;') + '"> ' + JsonElement.SelectVal.split(",")[i] + '</option>'
                        }
                        DivData += '</select></div>'
                        MainForm += DivData
                    }
                    else if (JsonElement.Type == "Margin") {
                        MainForm += '<div style="height:' + JsonElement.Height + 'px"></div>'
                    }
                    else if (JsonElement.Type == "Hr") {
                        MainForm += '<hr style="margin-right:20%;margin-left:20%;margin-top:' + JsonElement.MarginTop + 'px;margin-bottom:' + JsonElement.MarginBottom + 'px;' + Style + '" > '
                    }
                    else if (JsonElement.Type == "IndexNumber") {
                        var SpanId = ""
                        if (JsonElement.ElementId !== undefined) SpanId = "id='" + JsonElement.ElementId + "'"
                        MainForm += (JsonElement.BeforeBr == true ? "<br id='" + JsonElement.ElementId + "Br' />" : '') + '<span ' + SpanId + ' style="-webkit-user-select: none;margin-top:15px;font-weight:bold;font-size:large;display:inline-block;color:#2B3A63;font-family:Assistant;background-color:cadetblue ;padding:3px 6px;color:white;font-weight:normal;border-radius:2px;margin-left: -10px;vertical-align: top;">' + JsonElement.Text + '</span>'
                    } else if (JsonElement.Type == "Div") {
                        MainForm += '<div  id="' + JsonElement.ElementId + '" style="' + Style + ';' + Bold + '">' + JsonElement.Text + '</div>'
                    }
                    else if (JsonElement.Type == "DivOpen") {
                        MainForm += '<div  id="' + JsonElement.ElementId + '" style="' + Style + ';' + Bold + '">' + JsonElement.Text
                    }
                    else if (JsonElement.Type == "DivClose") {
                        MainForm += '</div>'
                    }
                    else if (JsonElement.Type == "List") {
                        MainForm += '<ol start=' + JsonElement.Number + ' style="-webkit-user-select:none;text-align:right;font-weight: bold;color: #2B3A63;' + (!JsonElement.Number ? 'list-style-type: disc;' : '') + ';' + Style + '"><li>' + JsonElement.Text + '</li></ol>'
                    }
                    else if (JsonElement.Type == "CheckBox") {


                        var FieldName = JsonElement.fieldName
                        if (JsonElement.fieldNameShow !== undefined) FieldName = JsonElement.fieldNameShow
                        MainForm += '<div id="' + JsonElement.ElementId + 'Div" class="checkbox" style="-webkit-user-select:none;width:' + JsonElement.Width + '%;display:inline-block;vertical-align:top;text-align:right;margin:10px 20px 10px 0px;' + Style + ';' + Bold + '"><label for="' + JsonElement.ElementId + '"><input type="CheckBox" dir="' + dir + '" id="' + JsonElement.ElementId + '"/>' + ((JsonElement.Mandatory == true) ? '<span id="Span_' + JsonElement.ElementId + '" style="color:indianred;">*</span>' : '<span id="Span_' + JsonElement.ElementId + '" style="color:indianred;display:none">*</span>') + '<span id="' + JsonElement.ElementId + '_Txt" style="cursor: pointer; width: 90%; display: inline-block; vertical-align: top;padding-right: 3px;">' + FieldName + '</span></label></div>'
                    }
                    else if (JsonElement.Type == "textarea") {
                        MainForm += '<div id="' + JsonElement.ElementId + 'Div" style="resize:none;width:' + JsonElement.Width + '%;display:inline-block;vertical-align:top;text-align:right;margin-top:10px;margin-right:20px;' + Style + '">' + Lbl + '<textarea class="TextBox"  rows="' + JsonElement.Rows + '" dir="' + dir + '" autocomplete="off" type="' + JsonElement.Type + '" style="width:90%;resize:none;" maxlength="' + JsonElement.MaxLength + '" id="' + JsonElement.ElementId + '" onfocus="ScrollUp(this)"/></div>'
                    }
                    else if (JsonElement.Type == "Text" || JsonElement.Type == "Tel") {
                        var OnInput = ""
                        if (JsonElement.Type == "Tel") OnInput = 'oninput="OnlyNumber(this.id)"'
                        MainForm += '<div class="DivTelText" id="' + JsonElement.ElementId + 'Div" style="width:' + JsonElement.Width + '%;display:inline-block;vertical-align:top;text-align:right;margin-top:10px;margin-right:20px;">' + Lbl + '<input class="TextBox" dir="' + dir + '" autocomplete="off" type="' + JsonElement.Type + '" style="width:90%" maxlength="' + JsonElement.MaxLength + '" id="' + JsonElement.ElementId + '" onfocus="ScrollUp(this)" ' + OnInput + '/></div>'
                    } else if (JsonElement.Type == "Radio") {
                        var Br = ""
                        if (JsonElement.br == true) Br = "<br/>"
                        var DivData = '<div id="' + JsonElement.ElementId + '" style="width:' + JsonElement.Width + '%;display:inline-block;vertical-align:top;text-align:right;margin: 15px 20px 10px;' + Style + '">' + Lbl
                        for (i = 0; i < JsonElement.RadioBt.length; i++) {
                            var Show = JsonElement.RadioBt[i].Text
                            if (JsonElement.RadioBt[i].Show !== undefined) { Show = JsonElement.RadioBt[i].Show }
                            DivData += '<div id="' + JsonElement.ElementId + '_RadioLbl' + i + '" style="display:inline-block"><label class="RadioBtLbl" for="' + JsonElement.ElementId + '_Radio' + i + '" style="' + Style + ';' + (JsonElement.RadioBt[i].Bold == true ? 'font-weight:bold' : '') + '"><input id="' + JsonElement.ElementId + '_Radio' + i + '" type="radio" name="' + JsonElement.ElementId + '" value="' + JsonElement.RadioBt[i].Text.replace(/"/g, '&quot;') + '"> <span id="' + JsonElement.ElementId + '_RadioLblShow' + i + '">' + Show + '</span></label></div>' + Br
                        }
                        DivData += '</div>'
                        MainForm += DivData
                    }
                    if (JsonElement.Br == true) MainForm += '<br/>';



                    // בדיקות
                    if (JsonElement.DbName !== undefined) {
                        if (CheckDbName.indexOf(JsonElement.DbName) > -1) { alert("נמצא כפילות DbName ב: " + JsonElement.DbName) }
                        if (JsonElement.DbName.substring(0, 5) != "Field") { alert("לא תקין DbName: " + JsonElement.DbName) }
                        if (JsonElement.DbName.indexOf("Max") > -1) {
                            if ($.isNumeric(JsonElement.DbName.split('Field')[1].split('Max')[0]) == false || JsonElement.DbName.split('Field')[1].split('Max')[1] != "") { alert("לא תקין DbName: " + JsonElement.DbName) }
                            if (JsonElement.DbName.split('Field')[1].split('Max')[0] < 1 || JsonElement.DbName.split('Field')[1].split('Max')[0] > 10) { alert("נמצא חריגה  DbNameMax: " + JsonElement.DbName) }
                        }
                        else if ($.isNumeric(JsonElement.DbName.split('Field')[1]) == false) { alert("לא תקין DbName: " + JsonElement.DbName) }
                        if (parseInt(JsonElement.DbName.split("Field")[1]) > 99) { alert("נמצא חריגה DbName ב: " + JsonElement.DbName) }
                        CheckDbName.push(JsonElement.DbName)
                    }

                    if (JsonElement.ElementId !== undefined) {
                        if (CheckElementId.indexOf(JsonElement.ElementId) > -1) { alert("נמצא כפילות ElementId ב: " + JsonElement.ElementId) }
                        CheckElementId.push(JsonElement.ElementId);
                    }

                    if (JsonElement.ElementId == "CreditCard" || JsonElement.ElementId == "CardExpiration") {
                        if ((Json.SpecialCheck.indexOf("CreditCardPayment") < 0) && (Json.SpecialCheck.indexOf("CreditCardToken") < 0)) { alert("לא קיימת שליחת אשראי.") }
                        if (JsonElement.DbName && JsonElement.ElementId == "CreditCard" && (Json.SpecialCheck.indexOf("CreditCardToken:" + JsonElement.DbName) < 0)) { alert("כרטיס אשראי נשלח ללא CreditCardToken") }
                    }
                }
            }

            $("#MainForm").html(MainForm);

            // קריאה אוטומטית להצגת הזמנות בטאב 1

        });


        // בדיקת גרסה
        function CheckVersion() {
            $.ajax({
                url: "Manage.aspx?Action=CheckVersion&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId,
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {
            }).error(function () {
                EAlertConfirm("שגיאה בקבלת נתונים. בדוק תקשורת")
            });
        }



        // קבלת הגדרות תופס
        function GetTofesSettings() {

            $.ajax({
                url: "Manage.aspx?Action=GetTofesSettings&TofesId=" + Json.TofesId + "&MosadId=" + Json.MosadId,
                type: 'POST',
                context: Text,
                timeout: 180000,
            }).success(function (JsonData) {
                AllowedUsesJson = JsonData;
                for (var Elem in AllowedUsesJson) {
                    var TempZeout = AllowedUsesJson[Elem].Data.split("ǂ");

                    var NewZeout = "";
                    for (var elem in TempZeout) {
                        if ($.isNumeric(TempZeout[elem])) {
                            NewZeout += TempZeout[elem];
                        }
                    }

                    AllowedUses.push(NewZeout);
                }
            }).error(function () {
                $("#ZeoutCheck").html('<div style="font-size: 19px;text-align: center;color: indianred; font-weight: bold;font-family: Assistant;margin-top: 50px;margin-bottom: 150px;"><span style="font-size:24px"></span>שגיאת תוכנה.<br/>פנה לתמיכה טכנית.</div>');
                $("#WaitDiv2").hide()
                EAlertConfirm("שגיאת תוכנה. פנה לתמיכה טכנית.");
            });

        }

        function Open_Tashlum() {

            if (MasofId !== '') {
                parent.GetMosadData(7009250, 'SetMosad', function () {
                    parent.GoToMenu('NewPaiement')
                })

            } else {
                window.open("https://www.matara.pro/nedarimplus/online/?mosad=7009250");
            }

        }




        function LoginSwal(Text, Id) {
            swal({
                type: "error",
                title: Text,
                showConfirmButton: true,
                allowOutsideClick: false,
            }, function () {
                $('#' + Id).focus()
                $('#' + Id).select();
                ScrollUp('#' + Id)
                setTimeout(function () {
                    $("#ZeoutCheckSave").show()
                    $("#ZeoutCheckWait").hide()
                }, 100);
            });
            return false;
        }



        function listCityOpenCloseCardFixed(Type, Num) {
            if (Type == "Close") {
                $("#CardFixed_" + Num + '_listCity').hide();
                $("#CardFixed_" + Num + '_listCity_Search').val('');
            }
            else {
                $("#CardFixed_" + Num + '_listCity').show().scrollTop(0)
                $("#CardFixed_" + Num + '_listCity_Search').focus();
            }
        }
        var listCityAllCity = []
        function listCityGetAllCity(data) {
            var city = data.CityId
            var Adders = data.StreetId
            var Action = data.Auto_Focus_After_City_Selection
            var listCitys = data.list_Citys


            $.ajax({
                url: "Manage.aspx?Action=GetCitys",
                context: Text,
                timeout: 16000,
            }).success(function (res) {

                if (res.Status == 'Error') {
                    swal({
                        title: res.Message,
                        type: "error",
                        showCancelButton: false,
                        confirmButtonText: 'אישור',
                        closeOnConfirm: true,
                        allowOutsideClick: false,
                    })
                    return false
                }

                for (i = 0; i < res.Data.length; i++) {
                    listCityAllCity.push({ name: res.Data[i].CityName.trim(), Cityid: res.Data[i].CityId.trim() })
                }

                if (listCitys) {
                    if (JSON.stringify(listCitys) != '[]') {
                        listCityAllCity = listCityAllCity.filter(function (elm) { return listCitys.indexOf(elm.name) > -1 })
                    }
                }

                listCityAllCity.sort(function (a, b) {
                    if (a.name < b.name) return -1
                    return a.name > b.name ? 1 : 0
                })

                listCityBuildHtml(city, Adders, Action)
            }).error(function () {
                swal({
                    title: "שגיאה בקבלת נתונים. בדוק תקשורת",
                    type: "error",
                    showCancelButton: false,
                    confirmButtonText: 'אישור',
                    closeOnConfirm: true,
                    allowOutsideClick: false,
                })
            })
        }


        function SendMail(Cause, Value) {
            $.ajax({
                type: "POST",
                url: "Manage.aspx?Action=JSError",
                context: Text,
                timeout: 30000,
                data: "Masof=" + encodeURIComponent(GetURLParameter("MasofId"))
                    + "&url=" + encodeURIComponent(window.location.href)
                    + "&msg=" + encodeURIComponent("<br/>" + "שליחת מייל עקב שגיאה חוזרת <br/> " + Cause + " :<br/> " + Value)
            });
        }


        function listCityBuildHtml(City, Adders, Action) {
            var html = ''
            html += '<style>'
            html += '.listCityModal {'
            html += 'display: none;'
            html += 'position: fixed;'
            html += 'z-index: 100;'
            html += 'left: 0;'
            html += 'top: 0;'
            html += 'width: 100%;'
            html += 'height: 100%;'
            html += 'overflow: auto;'
            html += 'padding: 14px 0;'
            html += 'background-color: rgba(0, 0, 0, 0.5);}'

            html += '.listCitymodal-content {'
            html += 'max-width:400px;'
            html += 'margin: 5px auto 20px;'
            html += 'background-color: #fefefe;'
            html += 'padding: 20px;'
            html += 'border: 1px solid #888;'
            html += 'width: 80%;'
            html += 'color: #808080;'
            html += 'font-family: "Assistant", sans-serif;'
            html += '-webkit-box-shadow: 0px 0px 30px 0px rgba(50, 50, 50, 0.75);'
            html += 'background-color: white;'
            html += 'max-width: 500px;'
            html += 'min-width: 200px;'
            html += 'min-height: 250px;'
            html += 'position: relative;'
            html += 'border-radius: 20px;'
            html += 'text-align: center;}'

            html += 'td {'
            html += 'color: #2B3A63;'
            html += 'font-size: 20px;'
            html += 'border-bottom: 1px solid #d7cece;'
            html += 'padding-left: 5px;'
            html += 'padding-right: 5px;'
            html += 'padding-top: 15px;'
            html += 'padding-bottom: 15px;}'


            html += 'th {'
            html += 'color: #2B3A63;'
            html += 'font-family: assistant,Arial;}'


            html += '.bordered td, .bordered th {'
            html += 'border-left: 1px solid #ccc;'
            html += 'border-top: 1px solid #ccc;'
            html += 'padding: 5px;'

            html += '.TableLightFont {'
            html += 'font-weight: lighter;'
            html += 'font-size: 14px;}'

            html += 'table {'
            html += 'border-collapse: collapse;'
            html += 'border: 1px solid #d7cece;'
            html += 'font-family: "Assistant", sans-serif;'
            html += 'margin-right: auto;'
            html += 'margin-left: auto;}'

            html += 'tr:nth-child(even) {'
            html += 'background-color: #f2f2f2;}'
            html += '</style>'


            html += '<div dir="rtl" id="CardFixed_1_listCity" class="listCityModal" onclick="if (event.target == this) listCityOpenCloseCardFixed(\'Close\', \'1\')">'
            html += '<div class="listCitymodal-content">'
            html += '<div style="-webkit-user-select: none;"> <span style="cursor: pointer; width: 25px; height: auto; margin-top: 10px; margin-right: 10px; position: absolute; background: indianred; padding: 6px 8px; color: white; font-weight: 600; font-size: 22px; border-radius: 8px 16px; top: -6px; right: -6px;" onclick="listCityOpenCloseCardFixed(\'Close\', \'1\')">X</span>'
            html += '<div style="text-align:center">'
            html += '<div style="display: inline-block; font-family: Assistant, sans-serif; font-size: 22px; color: #ff6a00; font-weight: bold; width: 90%; margin-top: 27px; margin-bottom: 10px; -webkit-user-select: none; text-align: center; padding: 0;">בחר עיר:</div>'
            html += '<input autocomplete="off" id="CardFixed_1_listCity_Search" style="-webkit-appearance: none; font-family: Assistant,Arial; font-size: large; color: #3f475e;outline: none; padding: 6px; border-color: #f7bb4d; border-style: solid; border-width: 0px 0px 2px 0px; margin: 5px 5px; background-color: #FFFFFB; -webkit-box-sizing: border-box;text-align:center" type="text" placeholder="חפש עיר" />'
            html += '<div style="padding: 5px 0 13px;">סה"כ תוצאות: <span id="CardFixed_1_listCity_Count"></span></div>'
            html += '<table id="CardFixed_1_listCity_Table" style="text-align:center;width:95%;font-size:medium;background-color:white"></table>'
            html += '</div></div></div></div>'


            if (Adders != '') {
                html += '<div dir="rtl" id="CardFixed_2_listCity" class="listCityModal" onclick="if (event.target == this) listCityOpenCloseCardFixed(\'Close\', \'2\')">'
                html += '<div class="listCitymodal-content">'
                html += '<div style="-webkit-user-select: none;"> <span style="cursor: pointer; width: 25px; height: auto; margin-top: 10px; margin-right: 10px; position: absolute; background: indianred; padding: 6px 8px; color: white; font-weight: 600; font-size: 22px; border-radius: 8px 16px; top: -6px; right: -6px;" onclick="listCityOpenCloseCardFixed(\'Close\', \'2\')">X</span>'
                html += '<div style="text-align:center">'
                html += '<div style="display: inline-block; font-family: Assistant, sans-serif; font-size: 22px; color: #ff6a00; font-weight: bold; width: 90%; margin-top: 27px; margin-bottom: 10px; -webkit-user-select: none; text-align: center; padding: 0;">בחר רחוב:</div>'
                html += '<input autocomplete="off" id="CardFixed_2_listCity_Search" style="-webkit-appearance: none; font-family: Assistant,Arial; font-size: large; color: #3f475e;outline: none; padding: 6px; border-color: #f7bb4d; border-style: solid; border-width: 0px 0px 2px 0px; margin: 5px 5px; background-color: #FFFFFB; -webkit-box-sizing: border-box;text-align:center" type="text" placeholder="חפש רחוב" />'
                html += '<div id="CardFixed_2_listCitywait" style="display:none;padding: 5px 0 13px;"><img style="width: 49px;" src="https://matara.pro/nedarimplus/waitnew.gif"/><div>נא להמתין..</div></div>'
                html += '<div id="CardFixed_2_listCity_Count" style="padding: 5px 0 13px;">סה"כ תוצאות: <span></span></div>'
                html += '<table id="CardFixed_2_listCity_Table" style="text-align:center;width:95%;font-size:medium;background-color:white"></table>'
                html += '</div></div></div>'
            }

            $('body').append(html)


            if (City != '') {
                $(City).focus(function () {
                    $(City).blur()
                    $("#CardFixed_1_listCity_Search").on('input', function () {
                        CardFixed_1_listCityDom($('#CardFixed_1_listCity_Search').val(), City, Adders, Action)
                    });
                    CardFixed_1_listCityDom('', City, Adders, Action)
                    listCityOpenCloseCardFixed('Open', '1')
                });
            }


            if (Adders != '') {
                $(Adders).focus(function () {
                    $(Adders).blur()
                    if ($(City).val() == '') {
                        $(City).focus()
                        return false
                    }

                    $("#CardFixed_2_listCity_Search").on('input', function () {
                        CardFixed_2_listCityDom($('#CardFixed_2_listCity_Search').val(), Adders)
                    });

                    CardFixed_2_listGetAdders('', Adders, City)
                    listCityOpenCloseCardFixed('Open', '2')
                });
            }

        }
        function CardFixed_1_listCityDom(Search, idcity, Idadders, Action) {
            $("#CardFixed_1_listCity_Table").html('')
            var KeyWord = Search.split(' ')
            var Counter = 0
            for (var i = 0; i < listCityAllCity.length; i++) {
                var Exist = true
                for (var j = 0; j < KeyWord.length; j++) {
                    if (listCityAllCity[i].name.indexOf(KeyWord[j]) < 0) { Exist = false }
                }
                if (listCityAllCity[i].name == Search) { Exist = true }
                if (Exist == true) {
                    Counter += 1
                    if (Counter > 200) continue;
                    $("#CardFixed_1_listCity_Table").append('<tr><td id="CardFixed_1_listCity_Table_Row_' + i + '" style="user-select: none;cursor:pointer;font-weight:bold;width:80%;text-align:right"><div style="text-align:center;font-size: 20px;color: #2B3A63;">' + listCityAllCity[i].name + '</div></td></tr>');
                    (function (i) {
                        $("#CardFixed_1_listCity_Table_Row_" + i).click(function () {
                            if ($(idcity).val() != listCityAllCity[i].name) {
                                $(idcity).val(listCityAllCity[i].name).attr('Cityid', listCityAllCity[i].Cityid)
                                $(Idadders).val('')
                            }

                            if (Action == true) {
                                $(Idadders).focus()
                            }
                            listCityOpenCloseCardFixed('Close', '1')
                        });
                    })(i);
                };
            }
            $('#CardFixed_1_listCity_Count').html(Counter)
        }
        var ValCity = ''
        var listCityAllAdders = []
        function CardFixed_2_listGetAdders(Search, Idadders, idcity) {
            if ($(idcity).val() == ValCity) {
                CardFixed_2_listCityDom(Search, Idadders)
                return false
            } else {
                ValCity = $(idcity).val()
            }

            $("#CardFixed_2_listCity_Table").html('')
            listCityAllAdders = []

            $("#CardFixed_2_listCity_Count").hide()
            $("#CardFixed_2_listCitywait").show()

            $.ajax({
                url: "Manage.aspx?Action=GetStreets&Cityid=" + $(idcity).attr('Cityid'),
                context: Text,
                timeout: 16000,
            }).success(function (res) {

                if (res.Status == 'Error') {
                    swal({
                        title: res.Message,
                        type: "error",
                        showCancelButton: false,
                        confirmButtonText: 'אישור',
                        closeOnConfirm: true,
                        allowOutsideClick: false,
                    })
                    return false
                }

                for (i = 0; i < res.Data.length; i++) {
                    listCityAllAdders.push({ name: res.Data[i].StreetName.trim() })
                }

                listCityAllAdders.sort(function (a, b) {
                    if (a.name < b.name) return -1
                    return a.name > b.name ? 1 : 0
                })

                CardFixed_2_listCityDom(Search, Idadders)
            }).error(function () {
                swal({
                    title: "שגיאה בקבלת נתונים. בדוק תקשורת",
                    type: "error",
                    showCancelButton: false,
                    confirmButtonText: 'אישור',
                    closeOnConfirm: true,
                    allowOutsideClick: false,
                })
            }).complete(function () {
                $("#CardFixed_2_listCity_Count").show()
                $("#CardFixed_2_listCitywait").hide()
            });
        }
        function CardFixed_2_listCityDom(Search, Idadders) {
            $("#CardFixed_2_listCity_Table").html('')
            var KeyWord = Search.split(' ')
            var Counter = 0
            for (var i = 0; i < listCityAllAdders.length; i++) {
                var Exist = true
                for (var j = 0; j < KeyWord.length; j++) {
                    if (listCityAllAdders[i].name.indexOf(KeyWord[j]) < 0) { Exist = false }
                }
                if (listCityAllAdders[i].name == Search) { Exist = true }
                if (Exist == true) {
                    Counter += 1
                    if (Counter > 200) continue;
                    $("#CardFixed_2_listCity_Table").append('<tr><td id="CardFixed_2_listCity_Table_Row_' + i + '" style="user-select: none;cursor:pointer;font-weight:bold;width:80%;text-align:right"><div style="text-align:center;font-size: 20px;color: #2B3A63;">' + listCityAllAdders[i].name + '</div></td></tr>');
                    (function (i) {
                        $("#CardFixed_2_listCity_Table_Row_" + i).click(function () {
                            $(Idadders).val(listCityAllAdders[i].name)
                            listCityOpenCloseCardFixed('Close', '2')
                        });
                    })(i);
                };
            }
            $('#CardFixed_2_listCity_Count span').html(Counter)
        }




        //swal({
        //    type: "warning",
        //    title: "שימו לב!",
        //    text: "סימנתם רק רישום לצהרון בקיץ, ללא רישום לצהרון בשנת הלימודים תשפ\"ג",
        //    showConfirmButton: true,
        //    confirmButtonText: "שלח טופס",
        //    confirmButtonColor: '#38c232',
        //    showCancelButton: true,
        //    cancelButtonText: "תיקון בחירה",
        //    allowOutsideClick: false,
        //    html: true
        //}, function (res) {
        //    if (res !== true) {
        //        $('#RishumTsaaron').focus()
        //        $('#RishumTsaaron').select();
        //        ScrollUp('#RishumTsaaron')
        //    } else {
        //        setTimeout(function () {
        //            SendData2();
        //        }, 500)
        //    }
        //});


        function GetOldTofesData() {


            if (parent.ClientJson) {
                ClientJson = parent.ClientJson;
            }

            $("#AllMainForm").hide();
            $("#WaitDiv2").show()
            $.ajax({
                url: "Manage.aspx?Action=GetOldTofesData&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId,
                data: "SessionId=" + encodeURIComponent(ClientJson.SessionId) + "&SessionPass=" + encodeURIComponent(ClientJson.SessionPass) + "&ClientId=" + encodeURIComponent(ClientJson.ID),
                type: 'POST',
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {
                $("#WaitDiv2").hide()
                $("#AllMainForm").show();

                //if (JsonData.Status == 'Error' && JsonData.Message == 'NOT FOUND') { return false }
                if (JsonData.Status == 'Error' && JsonData.Message == 'NOT FOUND') {
                    return false;
                }

                OldTofesId = JsonData.ID;
                $("#EditNote").show();

                for (var Element in Json.FormElements) {
                    var JsonElement = Json.FormElements[Element]
                    if (JsonElement.DbName !== undefined) {

                        if (JsonElement.Type == 'CheckBox') {
                            if (JsonData[JsonElement.DbName] == "מסומן") { $("#" + JsonElement.ElementId).prop('checked', true); }
                        } else if (JsonElement.Type == 'Radio') {
                            for (i = 0; i < JsonElement.RadioBt.length; i++) {
                                if (JsonElement.RadioBt[i].Text == JsonData[JsonElement.DbName]) { $("#" + JsonElement.ElementId + '_Radio' + i).prop('checked', 'checked') }
                            }
                        } else {
                            $("#" + JsonElement.ElementId).val(JsonData[JsonElement.DbName])
                        }

                    }

                }
                Calculate()
            }).error(function () {

                var BtTex = 'חזרה לנדרים פלוס'
                if (MasofId == '') BtTex = 'אישור'
                swal({
                    title: "שגיאה בקבלת נתונים. בדוק תקשורת",
                    type: "error",
                    showCancelButton: false,
                    confirmButtonText: BtTex,
                    closeOnConfirm: true,
                    allowOutsideClick: false,
                }, function (isConfirm) {
                    if (MasofId !== '') { parent.GoToMenu("Tafrit"); parent.closeIFrame() } else { $('html, body').scrollTop(0); location.reload(); }
                });

            });
        }


        function CheckDouble(FieldName, FieldData) {

            $.ajax({
                url: "Manage.aspx?Action=CheckDouble&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId + "&FieldName=" + encodeURIComponent(FieldName) + "&FieldData=" + encodeURIComponent(FieldData),
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {

            }).error(function () {
                EAlertConfirm("שגיאה בקבלת נתונים. בדוק תקשורת")
            }).complete(function () {
                if (ExamId !== '') GetExamData(Json.TofesId);
            });

        }


        function CheckDouble(FieldName, FieldData, Result, Function) {
            $.ajax({
                url: "Manage.aspx?Action=CheckDouble&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId + "&FieldName=" + encodeURIComponent(FieldName) + "&FieldData=" + encodeURIComponent(FieldData),
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {
                window[Result] = JsonData
                Function()
            }).error(function () {
                EAlertConfirm("שגיאה בקבלת נתונים. בדוק תקשורת")
            });
        }


        function UpdateClick() {
            if (MasofId !== '') parent.UpdateClick()
        }


        function GetClientData() {
            $("#AllMainForm").hide();
            $("#WaitDiv2").show()

            $.ajax({
                url: "Manage.aspx?Action=GetClientData&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId + "&ClientId=" + ClientId + "&Zeout=" + Zeout,
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {
                $("#WaitDiv2").hide()
                $("#AllMainForm").show();

                if (JsonData.Status == 'Error' && JsonData.Message == 'NOT FOUND') { return false }
                OldTofesId = JsonData.ID;
                $("#EditNote").show();

                for (var Element in Json.FormElements) {
                    var JsonElement = Json.FormElements[Element]
                    if (JsonElement.DbName !== undefined) {
                        if (JsonElement.Type == 'Radio') {
                            for (i = 0; i < JsonElement.RadioBt.length; i++) {
                                if (JsonElement.RadioBt[i].Text == JsonData[JsonElement.DbName]) { $("#" + JsonElement.ElementId + '_Radio' + i).prop('checked', 'checked') }
                            }
                        }
                        else
                            $("#" + JsonElement.ElementId).val(JsonData[JsonElement.DbName])
                    }
                }
                Calculate()

            }).error(function () {

                var BtTex = 'חזרה לנדרים פלוס'
                if (MasofId == '') BtTex = 'איפוס טופס'
                swal({
                    title: "שגיאה בקבלת נתונים. בדוק תקשורת",
                    type: "error",
                    showCancelButton: false,
                    confirmButtonText: BtTex,
                    closeOnConfirm: true,
                    allowOutsideClick: false,
                }, function (isConfirm) {
                    if (MasofId !== '') { parent.GoToMenu("Tafrit"); parent.closeIFrame() } else { $('html, body').scrollTop(0); location.reload(); }
                });

            });
        }


















        function Add_Client_Dt() {
            $("#Client_Div").hide();
            if (parent.ClientJson) {
                $("#ZeoutZ").val(parent.ClientJson.Zeout)
                $('#FullNameZ').val(parent.ClientJson.Name);
                $('#NHZ').val(parent.ClientJson.Adresse);
                $('#CityZ').val(parent.ClientJson.City);
                $('#TelZ').val(parent.ClientJson.Phone);
                $('#MailZ').val(parent.ClientJson.Mail);
            } else if (ClientJson) {
                $("#ZeoutZ").val(ClientJson.Zeout)
                $('#FullNameZ').val(ClientJson.Name);
                $('#NHZ').val(ClientJson.Adresse);
                $('#CityZ').val(ClientJson.City);
                $('#TelZ').val(ClientJson.Phone);
                $('#MailZ').val(ClientJson.Mail);
            }
        }



        //AllowCount:Field11;
        function GetSumCount() {
            $.ajax({
                url: "Manage.aspx?Action=GetSumCount&TofesId=1895&FiledName=Field11&Type=Count&Text=2", // Text לא חובה
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {
            }).error(function () {
                EAlertConfirm("שגיאה בקבלת נתונים. בדוק תקשורת")
            })

        }

        function GetPreData_UserName() {
            $.ajax({
                url: "Manage.aspx?Action=GetPreData_UserName&TofesId=" + Json.TofesId,
                data: "UserName=ASD" + encodeURIComponent("39660675") + "&Password=SDF", //לא חובה
                type: 'POST',
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {
                console.log(JsonData)
            }).error(function () {
                ParsePreData("ERROR")
            });
        }



        function SignCancel() {
            $('#SignPad,#WaitDiv').hide();
            $('#SaveDiv').show();
        }




        function GetMailData() {


            var data = "<div style='margin: auto;font-weight: 600;padding-left: 20px;width: 210mm;border: 1px solid #e9e9e9;position: relative;font-family: system-ui;padding:0 0 20px'>"
            data += "<div style='padding: 13px 20px 35px 21px; direction: rtl; font-size: 15px; color: gray; font-weight: 600; justify-content: space-between;'><div style='margin: 0 0 0 20px;display: inline-block;'>בס\"ד</div><div style='display: inline-block;    float: left;'>נוצר באמצעות [MasofId] | [TofesDate]</div></div>"

            data += '[MasofId]'
            data += '[Id]'
            data += '[TransactionId]'

            data += "<div dir='rtl' style='margin: 5px 25px 0 0;text-align: right;'>"
            data += "<div dir='rtl' style='margin: 0 0 30px; text-align: center; font-weight: 600; font-size: 20px; color: #171717;'>טופס הרשמה</div>"
            data += "<div style='margin: 5px 0 20px;color: cadetblue;font-size: 17px;'>פרטים אישיים:</div>"

            data += "<div style='margin: 5px 0 20px'>"
            data += "שם פרטי: <div style='display: inline-block;width: 180px;border-bottom: 1px solid #888888;padding:0 8px;'>" + $('#FirstName').val() + "</div>"
            data += "שם משפחה: <div style='display: inline-block;width: 180px;border-bottom: 1px solid #888888;padding:0 8px;'>" + $('#Family').val() + "</div>"
            data += "ת.ז: <div style='display: inline-block;width: 120px;border-bottom: 1px solid #888888;padding:0 8px;'>" + $('#Zeout').val() + "</div>"
            data += "</div>"

            data += "<div style='margin: 30px 0 20px;color: cadetblue;font-size: 17px;'>הערות:</div>"
            data += "<div style='margin: 5px 0 20px'>"
            data += "<div style='display: inline-block;width:700px;border-bottom: 1px solid #888888;padding:0 8px;'>" + $('#Notes').val() + "</div>"
            data += "</div>"



            data += '<div style="margin-left: 30px;text-align: left;direction: ltr;">'
            data += '<div style="width: 250px;">'
            data += '[Sign]'
            data += '</div>'
            data += ' <div style="padding: 0px 17px;border-top: 2px solid gray;width: max-content;padding: 0 100px;">חתימה</div>'
            data += '</div>'

            data += "</div>"
            data += "</div>"

            return data
        }


        function Calculate() {

            // מחיקת תו לא חוקי
            //if ($.isNumeric($('#Row' + i).val()) == false && $('#Row' + i).val().length > 1) { $('#Row' + i).val($('#Row' + i).val().substring(0,$('#Row' + i).val().length-1)) }
            //if ($.isNumeric($('#Row' + i).val()) == false) { $('#Row' + i).val(''); continue; }
            //if (parseFloat($('#Row' + i).val()) <0) { $('#Row' + i).val(''); continue; }



        }







        //feature_1
        function CloseNatsig() {
            $('#SnifChoose').hide();
            setTimeout(function () { ScrollUp($('#Snif1')) }, 100);
        }

        //feature_1
        function SetSnif(SnifName) {
            $("#Snif1").val(SnifName)
            CloseNatsig()
        }


        function ScrollUp(Input) {
            if ($(Input).val() !== undefined) {
                $('html, body').animate({ scrollTop: $(Input).position().top - 200 }, 'slow');
            }
        }



        function EAlertConfirm(message, insidetext) {
            swal({
                type: "error",
                title: message, text: insidetext,
                timer: 10000,
                showConfirmButton: true,
                allowOutsideClick: false,
            });
        }
        function IAlertConfirm(message, insidetext) {
            swal({
                type: "info",
                title: message, text: insidetext,
                timer: 30000,
                html: true,
                showConfirmButton: true,
                allowOutsideClick: false,
            });
        }
        function CheckFilled(Name, ErrorString) {
            if ($("#" + Name).val() == '') {
                swal({
                    type: "error",
                    title: ErrorString,
                    showConfirmButton: true,
                    allowOutsideClick: false,
                }, function () {
                    setTimeout(function () { $('#' + Name).focus() }, 100);
                });
                return false;
            } else {
                return true;
            }

        }
        function EnableForm(Enable) {
            $.ajax({
                url: "Manage.aspx?Action=EnableForm&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId + "&Enable=" + encodeURIComponent(Enable),
                context: Text,
                timeout: 60000,
            }).success(function (JsonData) {
                if (JsonData.Status == 'Error' || JsonData.Result == 'Error') {
                    EAlertConfirm("שגיאה", JsonData.Message)
                }
                else {
                    IAlertConfirm("הפעולה בוצעה בהצלחה");
                }
            }).error(function () {
                EAlertConfirm("שגיאה בקבלת נתונים. בדוק תקשורת")
            });
        }


        function GetExcel() {

            var url = "Manage.aspx?Action=GetExcel&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId
            var FormData = '<form action="' + url + '" method="post" target="_blank" style="display:none">'
            for (var Element in Json.FormElements) {
                var JsonElement = Json.FormElements[Element]
                if (JsonElement.Type == "Margin" || JsonElement.Type == "List" || JsonElement.Type == "Koteret" || JsonElement.DbName == undefined) { continue; }
                FormData += '<input type="text" name="' + JsonElement.DbName + '" value="' + JsonElement.fieldName.replace(/"/g, '&quot;').replace(/<b>/g, '').replace(/<\/b>/g, '') + '" />'

            }

            FormData += '</form>'
            var form = $(FormData);
            $('body').append(form);
            form.submit();

            //$.ajax({
            //    url: "Manage.aspx?Action=GetExcel&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId ,
            //    context: Text,
            //    timeout: 60000,
            //    type: "POST",
            //    data: PostData,
            //})

        }

        function IsVisible(Element) {
            if (Element == undefined) return false
            var element = document.getElementById(Element);
            while (element.parentNode) {
                if ($("#" + element.id).css('display') == 'none') return false
                element = element.parentNode;
            }
            return true
        }


        function getDate(Start, End) {
            // Formt - 24/02/2020
            if (End == 'Today') {
                End = new Date().getDate() + "/" + (new Date().getMonth() + 1) + "/" + new Date().getFullYear()
            }
            if (Start == 'Today') {
                Start = new Date().getDate() + "/" + (new Date().getMonth() + 1) + "/" + new Date().getFullYear()
            }

            var date1 = Start.split('/')
            var date2 = End.split('/');

            date1 = new Date(date1[2], date1[1], date1[0]);
            date2 = new Date(date2[2], date2[1], date2[0]);

            date1 = parseInt(date1.getTime() / 1000);
            date2 = parseInt(date2.getTime() / 1000);

            return ((date2 - date1) / 60 / 60 / 24).toFixed()
        }


        function GetTime() {

            $.ajax({
                url: "Manage.aspx?Action=GetTime",
                context: Text,
                timeout: 180000,
            }).success(function (JsonData) {

                Current_Houer = +JsonData.Time.split(":")[0];
                Current_Minute = +JsonData.Time.split(":")[1];
                GetMatrimJson();

            }).error(function () {
                $("#AllMainForm").html('<div style="font-size: 19px;text-align: center;color: indianred; font-weight: bold;font-family: Assistant;margin-top: 20px;margin-bottom: 15px;"><span style="font-size:24px">שים לב!</span><br>שגיאה בקבלת נתונים. יש לפנות לאחראי.<br /></div>');
                EAlertConfirm("שגיאה בקבלת נתונים. בדוק תקשורת")
                $("#WaitDiv2").hide()
                $("#AllMainForm").show()
            });

        }




        function SendData() {



            for (i = 1; i <= +$("#NumYladim").val(); i++) {
                if ($('#BDH1Yled' + i).val() !== "") {
                    if (CheckDate($('#BDH1Yled' + i).val()) == false) {
                        MySwal('תאריך לידה לא תקין', 'BDH1Yled' + i)
                        return false;
                    }
                }


                if ($('#ZeoutYled' + i).val() !== "") {
                    if (ValidateID($('#ZeoutYled' + i).val()) == false) {
                        MySwal('תעודת זהות לא תקינה', 'ZeoutYled' + i)
                        return false;
                    }
                }

            }


            if (GetURLParameter("Demo") == "1") { IAlertConfirm("זהו טופס לדוגמה. לא ניתן לבצע שליחה."); return false; }

            $("#SaveDiv").hide()
            $("#WaitDiv").show()


            //Calculate()
            var PostData = ''
            for (var Element in Json.FormElements) {
                var JsonElement = Json.FormElements[Element]
                if (JsonElement.Type == "Margin" || JsonElement.Type == "List" || JsonElement.Type == "Koteret") { continue; }
                if (JsonElement.ElementId == undefined) { continue; }

                var ElementValue
                var ElementVisible = true
                var ErrorTitle = "חובה למלא ";

                if (JsonElement.Type == "Radio") {
                    ElementValue = $('input[name=' + JsonElement.ElementId + ']:checked').val();
                    if (ElementValue == undefined) { ElementValue = '' };
                    if (IsVisible(JsonElement.ElementId) == false) { continue; }
                } else if (JsonElement.Type == "CheckBox") {
                    ErrorTitle = "חובה לסמן "
                    ElementValue = ($("#" + JsonElement.ElementId).is(":checked") ? "מסומן" : "")
                    if (IsVisible(JsonElement.ElementId) == false) { continue; }
                } else if (JsonElement.Type == "Select") {
                    ElementValue = $("#" + JsonElement.ElementId + " option:selected").val()
                    if (ElementValue == undefined) { ElementValue = '' };
                    if (IsVisible(JsonElement.ElementId) == false) { continue; }
                } else {
                    ElementValue = $("#" + JsonElement.ElementId).val().trim()
                    ElementVisible = IsVisible(JsonElement.ElementId)
                    if (Json.AllowChanges == false && ((ElementVisible == false || (ElementValue == '' && JsonElement.Mandatory == false)) && JsonElement.Send !== true)) { continue; };
                };

                //

                if (JsonElement.Mandatory == true && ElementValue == '' && ElementVisible == true) {
                    swal({
                        type: "error",
                        title: ErrorTitle + JsonElement.fieldName,
                        showConfirmButton: true,
                        allowOutsideClick: false,
                    }, function () {
                        $('#' + JsonElement.ElementId).focus()
                        $('#' + JsonElement.ElementId).select();
                        ScrollUp('#' + JsonElement.ElementId)
                        setTimeout(function () {
                            $("#SaveDiv").show()
                            $("#WaitDiv").hide()
                        }, 100);
                    });
                    return false;
                }

                if (JsonElement.Type == 'Tel' && ElementValue !== '' && $.isNumeric(ElementValue.replace(/-/g, "")) == false && $.isNumeric(ElementValue.replace(/\//g, "")) == false) {
                    swal({
                        type: "error",
                        title: "בשדה " + JsonElement.fieldName + " יש להזין ספרות בלבד",
                        showConfirmButton: true,
                        allowOutsideClick: false,
                    }, function () {
                        $('#' + JsonElement.ElementId).focus()
                        $('#' + JsonElement.ElementId).select();

                        setTimeout(function () {
                            $("#SaveDiv").show()
                            $("#WaitDiv").hide()
                        }, 100);
                    });
                    return false;
                }
                if (JsonElement.MinLenght !== undefined && ElementValue !== '' && ElementValue.length < JsonElement.MinLenght) {
                    swal({
                        type: "error",
                        title: "בשדה " + JsonElement.fieldName + " יש להזין לפחות " + JsonElement.MinLenght + " תווים",
                        showConfirmButton: true,
                        allowOutsideClick: false,
                    }, function () {
                        $('#' + JsonElement.ElementId).focus()
                        $('#' + JsonElement.ElementId).select();
                        setTimeout(function () {
                            $("#SaveDiv").show()
                            $("#WaitDiv").hide()
                        }, 100);
                    });
                    return false;
                }

                if (JsonElement.DbName == undefined) { continue; }
                PostData = PostData + "&" + JsonElement.DbName + "=" + encodeURIComponent(htmlEncode(ElementValue)) + "&" + JsonElement.DbName + "_Name=" + encodeURIComponent(JsonElement.fieldName.replace(/<b>/g, '').replace(/<\/b>/g, ''))




            }
            PostData = PostData.substring(1, PostData.length)



            //for (var i = 1; i < 21; i++) {
            //    if ($('#DivOpen' + i).css('display') != 'none') {
            //        if (ValidateID($('#KidId' + i).val()) == false) {
            //            MySwal('תעודת זהות לא תקינה', 'KidId' + i)
            //            return false
            //        }
            //    }
            //}


            //for (var i = 1; i <= 10; i++) {
            //    if ($('#KidBDE' + i).val() != '' && $('#Home_' + i).css('display') != 'none') {
            //        if (CheckDate($('#KidBDE' + i).val()) == false) { MySwal("נא להזין תאריך מלא ותקין", "KidBDE" + i); return false; }
            //        var TotalDate = getDate($('#KidBDE' + i).val(), today)
            //        if (TotalDate < 0) { MySwal("לא ניתן להזין תאריך עתידי", "KidBDE" + i); return false; }
            //    }
            //}


            //if ($("#TashlumAmount").val() !== undefined && ($.isNumeric($("#TashlumAmount").val()) == false || $("#TashlumAmount").val() == 0)) {
            //    EAlertConfirm("אין סכום לתשלום...");
            //    $("#SaveDiv").show()
            //    $("#WaitDiv").hide()
            //    return false;
            //}

            //if (IsVisible("CreditCard") == false) $("#CreditCard").val('')
            //var CreditCard_Type = 'Ragil'
            //var CreditCard_Amount = parseFloat($('#TashlumimNew').val()) * parseFloat($('#TashlumAmount1').val())
            //var CreditCard_Tashloumim = parseInt($('#TashlumimNew').val())

            // תשלומים
            //if ($('input[name=TashlumStatus]:checked').val() == "הו\"ק אשראי") {
            //    var CreditCard_Type = 'HK'
            //    var CreditCard_Amount = parseFloat($('#TashlumAmount').val())
            //    var CreditCard_Tashloumim = $('#TashlumimNew').val()
            //}

            //var Address = $("#Address").val() + " " + $("#City").val();
            //if ($('input[name=TashlumStatus]:checked').val() == "הו\"ק אשראי") { Address = $("#Address").val() }


            ///////////////CREDITCARD (CreditCardPayment)    *******
            //PostData += "&CreditCard_Type=" + encodeURIComponent(CreditCard_Type)
            //PostData += "&CreditCard_ClientName=" + encodeURIComponent($("#Family").val() + " " + $("#FirstName").val())
            //PostData += "&CreditCard_Amount=" + encodeURIComponent(CreditCard_Amount)
            //PostData += "&CreditCard_Zeout=" + encodeURIComponent($("#Zeout").val())
            //PostData += "&CreditCard_Adresse=" + encodeURIComponent(Address)
            //PostData += "&CreditCard_City=" + encodeURIComponent($("#City").val())
            //PostData += "&CreditCard_Tashloumim=" + encodeURIComponent(CreditCard_Tashloumim)
            //PostData += "&CreditCard_Phone=" + encodeURIComponent($("#Tel2").val())
            //PostData += "&CreditCard_CreditCard=" + encodeURIComponent($("#CreditCard").val())
            //PostData += "&CreditCard_Tokef=" + encodeURIComponent($("#CardExpiration").val())
            //PostData += "&CreditCard_Cvv=" + encodeURIComponent($("#CVV").val())
            //PostData += "&CreditCard_Mail=" + encodeURIComponent($("#Mail").val())
            //PostData += "&CreditCard_Currency=" //+ encodeURIComponent($("#Currency").val())
            //PostData += "&CreditCard_Comment=" //+ encodeURIComponent($("#Note").val())
            //PostData += "&CreditCard_HKDay=" //+ encodeURIComponent($("#HKDay").val())
            //PostData += "&CreditCard_Groupe=" //+ encodeURIComponent($("#HKDay").val())
            //PostData += "&CreditCard_Frequency=" //1. Normal | 2. Weekly  | 3. Izkor


            // OemHtml
            //PostData += "&HtmlMail=" + encodeURIComponent(htmlEncode(OemHtml));

            ///////////////MASAV (MasavPayment)  *******
            //PostData += "&Masav_ClientName=" + encodeURIComponent($("#Family").val() + " " + $("#FirstName").val())
            //PostData += "&Masav_ClientAdresse=" + encodeURIComponent($("#Address").val())
            //PostData += "&Masav_ClientZeout=" + encodeURIComponent($("#Zeout").val())
            //PostData += "&Masav_ClientPhone=" + encodeURIComponent($("#Tel").val())
            //PostData += "&Masav_ClientMail=" + encodeURIComponent($("#Mail").val())
            //PostData += "&Masav_Bank=" + encodeURIComponent($("#Bank").val())
            //PostData += "&Masav_Agency=" + encodeURIComponent($("#Snif").val())
            //PostData += "&Masav_Account=" + encodeURIComponent($("#Account").val())
            //PostData += "&Masav_Amount=" + encodeURIComponent($("#TashlumAmount").val())
            //PostData += "&Masav_Tashlumim=" + encodeURIComponent($("#Tashlumim option:selected").val())
            //PostData += "&Masav_Day=" + encodeURIComponent("5") //(1-5-10-15-20-28)
            //PostData += "&Masav_Comments=" + encodeURIComponent($("#Notes").val())
            //PostData += "&Masav_SignData=" + encodeURIComponent(SignData)
            //PostData += "&Masav_Groupe=" + encodeURIComponent("פדיון נפש")

            if (Json.NeedSign == true) {
                if (SignData == "") { $('#SignPad').show(); return false; }
                PostData += "&SignData=" + encodeURIComponent(SignData)
            }

            $.ajax({
                url: "Manage.aspx?Action=AddData&AjaxId=" + $.now() + "&MosadId=" + Json.MosadId + "&TofesId=" + Json.TofesId + "&Version=" + Json.Version + "&MasofId=" + MasofId + "&ClientId=" + ClientId + "&OldTofesId=" + OldTofesId + "&SpecialCheck=" + encodeURIComponent(Json.SpecialCheck) + "&MainTitle=" + encodeURIComponent(htmlEncode(Json.MainTitle)),
                context: Text,
                timeout: 32000,
                type: "POST",
                data: PostData,
            }).success(function (JsonData) {
                if (JsonData.Status == 'Error') {
                    if (JsonData.Message == 'הטופס לא מעודכן, יש לרענן את הדף.') {
                        swal({
                            type: "error",
                            title: JsonData.Message,
                            showConfirmButton: true,
                            allowOutsideClick: false,
                            confirmButtonText: 'רענן את הדף'
                        }, function () {
                            $('html, body').scrollTop(0); location.reload();
                        });
                        return false;
                    }
                    var FiledId
                    for (var Element in Json.FormElements) {
                        var JsonElement = Json.FormElements[Element]
                        if (JsonElement.DbName == JsonData.FieldId) FiledId = JsonElement.ElementId
                    }

                    swal({
                        type: "error",
                        title: JsonData.Message,
                        showConfirmButton: true,
                        allowOutsideClick: false,
                    }, function () {
                        if (FiledId !== undefined) {
                            $('#' + FiledId).focus();
                            $('#' + FiledId).select();
                            ScrollUp('#' + FiledId);
                        }

                        setTimeout(function () {
                            $("#SaveDiv").show()
                            $("#WaitDiv").hide()
                        }, 100);
                    });
                    return false;
                }
                else {
                    $("#WaitDiv").hide();
                    var BtTex = 'חזרה לנדרים פלוס'
                    if (MasofId == '') BtTex = 'אישור'
                    swal({
                        title: "הטופס נשלח בהצלחה",
                        // מספר טופס
                        // text: JsonData.Message,
                        type: "success",
                        showCancelButton: false,
                        confirmButtonText: BtTex,
                        closeOnConfirm: true,
                        allowOutsideClick: false,
                    }, function (isConfirm) {
                        if (MasofId !== '') { parent.GoToMenu("Tafrit"); parent.closeIFrame() } else { $('html, body').scrollTop(0); location.reload(); }
                    });


                }

            }).error(function () {
                EAlertConfirm("שגיאה בקבלת נתונים. בדוק תקשורת")
                $("#SaveDiv").show()
                $("#WaitDiv").hide()
            });
        }


        function FixedWaitingStyle() {
            $('#FixedWaiting img').css('top', (($('#FixedWaiting').height()) / 2) - ($('#FixedWaiting img').height() / 2))
            $('#FixedWaiting img').css('left', (($('#FixedWaiting').width()) / 2) - ($('#FixedWaiting img').width() / 2))
        }


    </script>
</head>

<body onresize="FixedWaitingStyle()" dir="rtl" style="background: #eee;-webkit-user-select: none;"
    onscroll="UpdateClick()" oninput="UpdateClick()">

    <div id="FixedWaiting"
        style="width: 100%; height: 100vh; top: 0; left: 0; position: fixed; z-index: 101; background: rgba(66 ,66 ,66 ,0.47);display:none;">
        <img style="position: absolute; background: white; border-radius: 20%; top: 423px; left: 267px; width: 75px; height: 75px;"
            src="waitnew.gif" alt="waiting" />
    </div>


    <!--כפתורים עליונים-->
    <div id="BackToNedarim" style="text-align:center;margin-top:10px;display:none"> <input class="Bt"
            style="background-color:#ff6a00;display:inline-block;min-width:40%;padding:8px" type="button"
            value="חזרה לנדרים פלוס" id="BackToNedarimBottom" onclick="if (MasofId !== '') parent.closeIFrame()" />
    </div>
    <div id="AdminBt" style="text-align:center;margin-top:10px;display:none">
        <input class="Bt" style="background-color:#006400;display:inline-block;min-width:20%;padding:8px;cursor:pointer"
            type="button" value="ייצוא לאקסל" onclick="GetExcel()" />
        <input class="Bt"
            style="background-color:indianred;display:inline-block;min-width:20%;padding:8px;cursor:pointer"
            type="button" value="איפוס המאגר" onclick="ResetForm()" />
        <div style="width:50%;font-size:0px;max-width:300px;margin-right:auto;margin-left:auto">
            <!--מצב טופס-->
            <div
                style="margin-top:10px;margin-bottom:5px;padding:3px 0px;background-color:white; border-radius:5px;width:100%;text-align:center;margin-right:auto;margin-left:auto;font-size:small;color:#2B3A63;font-weight:bold">
                מצב טופס:</div>
            <input class="Bt"
                style="background-color:#38C232;display:inline-block;width:48%;margin-left:2%;padding:8px;cursor:pointer"
                type="button" value="פעיל" onclick="EnableForm('True')" />
            <input class="Bt"
                style="background-color:#e60a00;display:inline-block;width:48%;margin-right:2%;padding:8px;cursor:pointer"
                type="button" value="לא פעיל" onclick="EnableForm('False')" />
        </div>
    </div>


    <div style="text-align: right;border-radius: 5px;width: 98%;padding: 20px 10px;max-width: 500px;margin: auto;box-sizing: border-box;"
        id="Logo">
        <div style="text-align: center;">
            <img onclick="ReloadPOS()" style="border: 0px solid #f1f1f1; border-radius: 7px; height: 100px;"
                src="https://images.matara.pro/ClientsImages/3590_7013571.jpg" alt="Logo">
        </div>

        <div class="BatteryStatus" onclick="GetBattery()"
            style="position: absolute; left: 3px; top: 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: rgb(74, 74, 74); cursor: pointer; height: 41px; box-sizing: border-box; border: 1px solid rgb(213, 213, 213); border-radius: 3px; padding: 5px; flex-direction: column-reverse; ">
        </div>
    </div>


    <!--כל הטופס-->
    <div
        style="text-align: right; background-color: white; border-radius: 5px; margin-top: 5px; width: 98%; margin-left: auto; margin-right: auto; max-width: 500px; position: relative; padding-bottom: 1px;">





        <script>

            //TODO: clean
            // var UserToken = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyTmFtZSI6InNydWxpayIsInVzZXJJZCI6ImNjOTN3eFo2Q0NpR3dSY3ZwNDNkIiwiaWF0IjoxNzUyMDcyNjQyLCJleHAiOjE3NTIyNDU0NDJ9.UaW-oDQxO8y5I-hMpl2weZaeqTGpI_eybkfcixCjiBU"
            // var UserName = "srulik kenig";
            var UserToken = "";
            var Role = 0;
            var OrderId = "";
            var UserName = "";
            var UserType;
            var CurrentTab = 1; // משתנה לשמירת הטאב הנוכחי

            // מערכת מעקב אחר פעילות משתמש לבדיקת הודעות
            window.LastUserActivity = Date.now();
            window.UnreadMessagesInterval = null;
            window.LastUnreadCount = 0; // משתנה לשמירת מספר ההודעות שלא נקראו

            function ShowMainScreen() {
                // הסתרת מסכי הכניסה והצגת המסך הראשי
                $(".Card").hide();
                $("#Logo").hide();
                $("#CardGetMagneticCard").hide();
                $("#DivOrders").show();

                // יצירת הטאבים
                CreateTabs();

                // הצגת מסך הבחירה הראשוני כברירת מחדל
                ShowTab(0);
            }

            // פונקציה לבדיקת מצב המשתמש הנוכחי - ניתן לקרוא מהקונסול
            function checkUserStatus() {
                return {
                    userName: UserName,
                    userToken: UserToken,
                    userType: UserType,
                    isLoggedIn: !!UserToken && !!UserName
                };
            }

            // פונקציה לפענוח טוקן JWT - ניתן לקרוא מהקונסול
            function decodeUserToken() {
                if (!UserToken) {
                    return null;
                }

                try {
                    // הסרת "Bearer " מהתחלה
                    var token = UserToken.replace("Bearer ", "");
                    // פיצול הטוקן לחלקים
                    var parts = token.split('.');
                    if (parts.length !== 3) {
                        return null;
                    }

                    // פענוח החלק השני (payload)
                    var payload = JSON.parse(atob(parts[1]));
                    return payload;
                } catch (error) {
                    return null;
                }
            }

            function CreateTabs() {
                // Tabs are now part of the unified navigation - no need to create them dynamically
                // Just update the employee name
                $(".UserName").html(UserName);
            }

            // Toggle hamburger menu
            function toggleMenu() {
                var menu = $("#menuDropdown");
                menu.toggleClass("show");
            }

            // Update screen name based on current tab
            function updateScreenName(tabNumber) {
                var screenNames = {
                    0: "בחר מסך",
                    1: "הזמנות",
                    2: "ליקוט",
                    3: "משלוחים",
                    4: "הודעות",
                    5: "ספירת מלאי",
                    6: "מדבקות מיקום"
                };
                $("#screenName").text(screenNames[tabNumber] || "");

                // Update active menu item
                $(".menu-item").removeClass("active");
                if (tabNumber >= 1 && tabNumber <= 6) {
                    $(".menu-item").eq(tabNumber - 1).addClass("active");
                }
            }

            // Create visual selection screen - Clean system design
            function createSelectionScreen() {
                var html = '<div style="padding: 20px 15px;">';
                html += '<div style="text-align: center; font-size: 20px; font-weight: bold; color: #009688; margin-bottom: 20px;">בחר מסך לעבודה</div>';
                
                // Create a simple list of menu items (similar to hamburger menu style)
                html += '<div style="display: flex; flex-direction: column; gap: 10px; max-width: 500px; margin: 0 auto;">';
                
                // Menu item 1: הזמנות
                html += '<div class="selection-card" onclick="ShowTab(1)">';
                html += '<i class="fa-solid fa-box"></i>';
                html += '<span>הזמנות</span>';
                html += '</div>';
                
                // Menu item 2: ליקוט
                html += '<div class="selection-card" onclick="ShowTab(2)">';
                html += '<i class="fa-solid fa-hand-holding"></i>';
                html += '<span>ליקוט</span>';
                html += '</div>';
                
                // Menu item 3: משלוחים
                html += '<div class="selection-card" onclick="ShowTab(3)">';
                html += '<i class="fa-solid fa-truck"></i>';
                html += '<span>משלוחים</span>';
                html += '</div>';
                
                // הודעות removed - direct access via top bar button
                
                // Menu item 5: ספירת מלאי
                html += '<div class="selection-card" onclick="ShowTab(5)">';
                html += '<i class="fa-solid fa-clipboard-list"></i>';
                html += '<span>ספירת מלאי</span>';
                html += '</div>';
                
                // Menu item 6: מדבקות מיקום
                html += '<div class="selection-card" onclick="ShowTab(6)">';
                html += '<i class="fa-solid fa-tags"></i>';
                html += '<span>מדבקות מיקום</span>';
                html += '</div>';
                
                html += '</div>'; // Close flex container
                html += '</div>'; // Close padding container
                
                $("#TabContent0").html(html);
            }

            function ShowTab(tabNumber, orderId) {
                // עדכון זמן פעילות אחרונה
                window.LastUserActivity = Date.now();

                // הפעלת מערכת בדיקת הודעות אם עדיין לא פעילה
                if (!window.UnreadMessagesInterval) {
                    startUnreadMessagesCheck();
                }

                if (tabNumber !== undefined) {
                    CurrentTab = tabNumber;
                }
                if (orderId) {
                    window.OrderId = orderId;
                }

                // Close the hamburger menu
                $("#menuDropdown").removeClass("show");

                // Update screen name
                updateScreenName(CurrentTab);

                // עדכון עיצוב הטאבים - not needed anymore with hamburger menu
                $(".tab-button").css({
                    "background": "#e0e0e0",
                    "color": "#666",
                    "border-bottom": "3px solid transparent"
                });

                $("#Tab" + CurrentTab).css({
                    "background": "#009688",
                    "color": "white",
                    "border-bottom": "3px solid #00695c"
                });

                // הסרת הכפתורים הקודמים אם קיימים
                $("#actionButtons").remove();

                // עדכון תוכן המסך
                var content = "";
                $("#TabContent0").hide();
                $("#TabContent1").hide();
                $("#TabContent2").hide();
                $("#TabContent3").hide();
                $("#TabContent4").hide();
                $("#TabContent5").hide();
                $("#TabContent6").hide();
                
                switch (CurrentTab) {
                    case 0:
                        // Selection screen - show visual menu cards
                        $("#TabContent0").show();
                        createSelectionScreen();
                        break;
                    case 1:
                        // איפוס OrderId כשחוזרים לטאב הזמנות
                        window.OrderId = "";

                        $("#TabContent1").show();
                        // הוספת כותרת ואז שדה חיפוש (כמו בטאב 3)
                        var titleHtml1 = '<div style="text-align: center; font-size: 18px; font-weight: bold; color: #009688; margin: 10px 0;">הזמנות לליקוט</div>';

                        // פילטר עם 3 כפתורים - בהתאם לבחירה הנוכחית
                        var currentFilter = window.OrderFilter || 'new';
                        var filterHtml1 = '<div style="display: flex; justify-content: center; align-items: center; margin: 15px 0;">';
                        filterHtml1 += '<div style="background: #f0f0f0; border-radius: 25px; padding: 3px; display: inline-flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">';

                        // כפתור "שלי"
                        var mineStyle = (currentFilter === 'mine') ? 'color: white; background: #009688;' : 'color: #666; background: transparent;';
                        filterHtml1 += '<button id="filterMine" onclick="setOrderFilter(\'mine\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; ' + mineStyle + '">שלי</button>';

                        // כפתור "חדש"
                        var newStyle = (currentFilter === 'new') ? 'color: white; background: #009688;' : 'color: #666; background: transparent;';
                        filterHtml1 += '<button id="filterNew" onclick="setOrderFilter(\'new\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; ' + newStyle + '">חדש</button>';

                        // כפתור "הכל"
                        var allStyle = (currentFilter === 'all') ? 'color: white; background: #009688;' : 'color: #666; background: transparent;';
                        filterHtml1 += '<button id="filterAll" onclick="setOrderFilter(\'all\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; ' + allStyle + '">הכל</button>';

                        filterHtml1 += '</div>';
                        filterHtml1 += '</div>';

                        var searchHtml1 = '<div style="display: flex; justify-content: center; align-items: center; padding: 0 10px 20px;">';
                        searchHtml1 += '<input autocomplete="off" type="search" id="Filter_Search" oninput="Filter_Search()" placeholder="חיפוש לפי מס\' הזמנה" style="border: 1px solid rgb(212, 212, 212);outline-color: rgb(217 217 217);padding: 6px;font-size: 16px;background: rgb(255, 255, 255);text-align: center;margin-left: 6px;width: 211px;border-radius: 5px;height: 35px;">';
                        searchHtml1 += '</div>';
                        $("#TabContent1").html(titleHtml1 + filterHtml1 + searchHtml1 + '<div id="Tab1List"></div>');
                        getOrders();
                        break;
                    case 2:
                        $("#TabContent2").show();
                        // ללא שדה חיפוש בפיזור
                        var html = '<div style="padding: 10px;">';
                        html += '<div id="Tab2List"></div>';
                        html += '</div>';
                        $("#TabContent2").html(html);

                        getOrderProducts();
                        break;
                    case 3:
                        $("#TabContent3").show();
                        GetOrders();
                        break;
                    case 4:
                        $("#TabContent4").show();
                        GetMessages();
                        break;
                    case 5:
                        // ספירת מלאי - placeholder for now
                        $("#TabContent5").show();
                        var html5 = '<div style="padding: 20px; text-align: center;">';
                        html5 += '<div style="font-size: 24px; font-weight: bold; color: #009688; margin-bottom: 20px;">ספירת מלאי</div>';
                        html5 += '<div style="font-size: 16px; color: #666;">מסך זה בפיתוח</div>';
                        html5 += '</div>';
                        $("#TabContent5").html(html5);
                        break;
                    case 6:
                        // מדבקות מיקום - placeholder for now
                        $("#TabContent6").show();
                        var html6 = '<div style="padding: 20px; text-align: center;">';
                        html6 += '<div style="font-size: 24px; font-weight: bold; color: #009688; margin-bottom: 20px;">מדבקות מיקום</div>';
                        html6 += '<div style="font-size: 16px; color: #666;">מסך זה בפיתוח</div>';
                        html6 += '</div>';
                        $("#TabContent6").html(html6);
                        break;
                }

            }

            function GetMessages() {
                $.ajax({
                    url: `${window.baseUrl}posApi/messages`,
                    headers: {
                        "authorization": UserToken
                    },
                    context: Text,
                    timeout: 60000,
                    global: false,
                }).success(function (Response) {
                    renderMessages(Response.data);
                    if (Response.status == 'error') {
                        MySwal(Response.massege)
                        return false;
                    }
                }
                ).error(function () {
                    MySwal("שגיאה בקבלת נתונים. בדוק תקשורת")
                })
            }

            function renderMessages(messages) {
                const container = document.getElementById("TabContent4");
                container.innerHTML = "";

                // קונטיינר עם גלילה - בדיוק כמו בטאבים האחרים
                const scrollableContainer = document.createElement("div");
                scrollableContainer.style.cssText = `
                    padding: 0 10px 80px 10px;
                    overflow-y: auto;
                    max-height: calc(100vh - 200px);
                `;

                if (messages.length === 0) {
                    scrollableContainer.innerHTML = "<p style='text-align:center;color:#888;padding:20px 0;'>אין הודעות להצגה</p>";
                } else {
                    messages.forEach((msg) => {
                        const messageDiv = document.createElement("div");

                        // קובע אם ההודעה מימין או משמאל
                        const isSystem = msg.role === "system";
                        messageDiv.style.cssText = `
                display: flex;
                justify-content: ${!isSystem ? "flex-end" : "flex-start"};
                margin: 10px 0;
                padding: 0 10px;
            `;

                        // בלון ההודעה
                        const bubble = document.createElement("div");
                        bubble.style.cssText = `
                background: ${isSystem ? "#0084ff" : "#f0f0f0"};
                color: ${isSystem ? "#fff" : "#000"};
                padding: 12px 16px;
                border-radius: 20px;
                max-width: 65%;
                word-wrap: break-word;
                font-size: 15px;
                line-height: 1.4;
                ${!isSystem ? "border-bottom-left-radius: 4px;" : "border-bottom-right-radius: 4px;"}
                box-shadow: 0 1px 2px rgba(0,0,0,0.15);
                position: relative;
            `;

                        // תוכן ההודעה
                        const messageText = document.createElement("div");
                        messageText.textContent = msg.message || "";
                        messageText.style.cssText = "margin-bottom: 4px;";

                        // זמן ההודעה
                        const timestamp = document.createElement("div");
                        timestamp.textContent = formatTimestamp(msg.timestamp);
                        timestamp.style.cssText = `
                font-size: 11px;
                color: ${isSystem ? "rgba(255,255,255,0.8)" : "#666"};
                text-align: ${isSystem ? "right" : "left"};
                margin-top: 4px;
            `;

                        bubble.appendChild(messageText);
                        bubble.appendChild(timestamp);
                        messageDiv.appendChild(bubble);
                        scrollableContainer.appendChild(messageDiv);
                    });
                }

                // הוספת הקונטיינר הראשי
                container.appendChild(scrollableContainer);

                // אזור כתיבת הודעה - fixed בתחתית (מחוץ לcontainer)
                const inputArea = document.createElement("div");
                inputArea.style.cssText = `
        display: flex;
        gap: 8px;
        padding: 10px;
        background: #f5f5f5;
        border-top: 1px solid #ddd;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 500px;
        margin: 0 auto;
        z-index: 10;
    `;

                const messageInput = document.createElement("input");
                messageInput.type = "text";
                messageInput.id = "messageInput";
                messageInput.placeholder = "הקלד הודעה...";
                messageInput.style.cssText = `
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
        font-size: 16px;
    `;

                // טיפול במקלדת אנדרואיד
                messageInput.addEventListener("focus", function () {
                    setTimeout(() => {
                        // גלילה של הקונטיינר להודעה האחרונה
                        scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                        // גלילה של כל העמוד כדי שה-input יהיה נראה
                        this.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 350);
                });

                messageInput.addEventListener("keypress", function (event) {
                    if (event.key === "Enter") {
                        SendMessage();
                    }
                });

                const sendButton = document.createElement("button");
                sendButton.textContent = "שלח";
                sendButton.style.cssText = `
        padding: 12px 24px;
        background: #0084ff;
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    `;
                sendButton.addEventListener("click", SendMessage);

                inputArea.appendChild(messageInput);
                inputArea.appendChild(sendButton);

                // הוספת input אחרי הcontainer (לא בתוכו)
                container.appendChild(inputArea);

                // גלילה אוטומטית לתחתית (רק אם יש הודעות)
                if (messages.length > 0) {
                    setTimeout(() => {
                        scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                    }, 100);
                }
            }

            // פונקציית שליחת הודעה
            function SendMessage() {
                const input = document.getElementById("messageInput");
                const message = input.value.trim();

                if (!message) {
                    MySwal("נא להזין הודעה");
                    return;
                }

                $.ajax({
                    url: `${window.baseUrl}posApi/messages`,
                    method: 'POST',
                    contentType: 'application/json',
                    headers: {
                        "authorization": UserToken
                    },
                    data: JSON.stringify({
                        message: message,
                    }),
                    timeout: 60000,
                }).success(function (Response) {
                    if (Response.status == 'ok') {
                        input.value = ""; // ניקוי השדה
                        MySwal("ההודעה נשלחה בהצלחה", undefined, "success");
                        ShowTab(4); // רענון ההודעות
                    } else {
                        MySwal(Response.massege || "שגיאה בשליחת ההודעה");
                    }
                }).error(function () {
                    MySwal("שגיאה בשליחת ההודעה. בדוק תקשורת");
                });
            }


            // בדיקת כמות הודעות שלא נקראו
            function CheckUnreadMessages() {
                $.ajax({
                    url: `${window.baseUrl}posApi/unreadMessagesCount`,
                    headers: {
                        "authorization": UserToken
                    },
                    timeout: 10000,
                    global: false,
                }).success(function (Response) {
                    if (Response.status == 'ok' && Response.data !== undefined) {
                        var count = parseInt(Response.data);
                        
                        // בדיקה אם יש הודעה חדשה (המספר גדל)
                        if (count > window.LastUnreadCount) {
                            MySwal("קיבלת הודעה חדשה", undefined, "success");
                        }
                        
                        // עדכון המספר האחרון
                        window.LastUnreadCount = count;
                        
                        if (count > 0) {
                            $("#UnreadMessagesCount").text(count).show();

                            if (CurrentTab === 4) {
                                GetMessages();
                            }
                        } else {
                            $("#UnreadMessagesCount").hide();
                        }
                    }
                }).error(function () {
                    // שגיאה בשקט - לא להפריע למשתמש
                    console.log("שגיאה בבדיקת הודעות שלא נקראו");
                });
            }

            // הפעלת מערכת בדיקה אוטומטית של הודעות
            function startUnreadMessagesCheck() {
                // אם כבר יש interval פעיל, לא נפעיל עוד אחד
                if (window.UnreadMessagesInterval) {
                    return;
                }

                // ביצוע בדיקה ראשונית מיידית
                CheckUnreadMessages();

                // הפעלת interval שבודק כל 15 שניות
                window.UnreadMessagesInterval = setInterval(function () {
                    var timeSinceLastActivity = Date.now() - window.LastUserActivity;
                    var fiveMinutes = 5 * 60 * 1000; // 5 דקות במילישניות

                    if (timeSinceLastActivity < fiveMinutes || CurrentTab === 4) {
                        // המשתמש פעיל - בצע בדיקה
                        CheckUnreadMessages();
                    } else {
                        // עברו יותר מ-5 דקות - הפסק את ה-interval
                        clearInterval(window.UnreadMessagesInterval);
                        window.UnreadMessagesInterval = null;
                        console.log("הופסקה בדיקת הודעות עקב חוסר פעילות");
                    }
                }, 15000); // כל 15 שניות
            }

            // פונקציה עזר לעיצוב תאריך
            function formatTimestamp(timestamp) {
                if (!timestamp) return "";

                try {
                    let date;

                    // אם זה אובייקט JSON עם _seconds
                    if (timestamp._seconds !== undefined) {
                        date = new Date(timestamp._seconds * 1000);
                    }
                    // אחרת ננסה ליצור Date רגיל
                    else {
                        date = new Date(timestamp);
                    }

                    // בדיקה אם זה היום או אתמול
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                    const timeString = date.toLocaleString("he-IL", {
                        hour: "2-digit",
                        minute: "2-digit",
                    });

                    if (messageDate.getTime() === today.getTime()) {
                        return "היום " + timeString;
                    } else if (messageDate.getTime() === yesterday.getTime()) {
                        return "אתמול " + timeString;
                    } else {
                        return date.toLocaleString("he-IL", {
                            day: "2-digit",
                            month: "2-digit",
                            year: "numeric",
                            hour: "2-digit",
                            minute: "2-digit",
                        });
                    }
                } catch (err) {
                    console.error("שגיאה בהמרת תאריך:", err);
                    return "";
                }
            }



            function CheckUser() {
                console.log(`${window.baseUrl}posApi/login`);

                $.ajax({
                    type: "POST",
                    url: `${window.baseUrl}posApi/login`,
                    data: { "userName": $("#CheckUserName").val(), "password": $("#CheckUserPass").val() },
                    context: Text,
                    timeout: 60000,
                }).success(function (Response) {

                    if (Response.status == 'error') {
                        MySwal(Response.massege)
                        return false;
                    }

                    UserToken = "Bearer " + Response.token
                    UserName = Response.userName
                    Role = Response.role
                    console.log('*** Res: ', Response);


                    // פענוח טוקן אוטומטי אחרי התחברות
                    decodeUserToken();

                    $(".UserName").html(UserName)
                    ShowMainScreen()


                }).error(function () {
                    MySwal("שגיאה בקבלת נתונים. בדוק תקשורת")
                })
            }

            var ListOrders = []
            var ListShippingProducts = []

            function GetShippingProducts() {

                // איפוס בחירות בטאב 3 בכל רענון
                window.SelectedShippingProducts = [];
                $.ajax({
                    url: `${window.baseUrl}posApi/productsShipping`,
                    context: Text,
                    timeout: 16000,
                    headers: {
                        "authorization": UserToken
                    }
                }).success(function (Response) {
                    if (Response.status == 'error') {
                        MySwal(Response.massege)
                        return false;
                    }
                    ListShippingProducts = Response.data;
                    var shippingProducts = ListShippingProducts || [];

                    // מערך בחירות למוצרי משלוח
                    window.SelectedShippingProducts = window.SelectedShippingProducts || [];
                    var html = '';
                    html += '<div style="padding: 0 10px 70px;">';
                    html += '<div style="text-align: center; font-size: 18px; font-weight: bold; color: #009688; margin: 10px 0;">מוצרים למשלוח</div>';

                    // טוגל בוטון לבחירת סוג התצוגה
                    html += '<div style="display: flex; justify-content: center; align-items: center; margin: 10px 0;">';
                    html += '<div style="background: #f0f0f0; border-radius: 25px; padding: 3px; display: inline-flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">';
                    html += '<button id="viewByOrders" onclick="toggleShippingViewMode(\'orders\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; color: ' + (window.ShippingViewMode === 'orders' ? 'white' : '#666') + '; background: ' + (window.ShippingViewMode === 'orders' ? '#009688' : 'transparent') + ';">הזמנות</button>';
                    html += '<button id="viewByProducts" onclick="toggleShippingViewMode(\'products\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; color: ' + (window.ShippingViewMode === 'products' ? 'white' : '#666') + '; background: ' + (window.ShippingViewMode === 'products' ? '#009688' : 'transparent') + ';">כמויות</button>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div id="ShippingProductsList">';
                    if (shippingProducts.length === 0) {
                        html += '<div style="text-align:center; color:#bdbdbd; font-size:15px; padding:10px 0;">אין מוצרים למשלוח</div>';
                    } else {
                        for (var i = 0; i < shippingProducts.length; i++) {
                            html += renderShippingProductRow(shippingProducts[i], i);
                        }
                    }
                    html += '</div>';
                    html += '</div>';

                    // פס קבוע בתחתית TAB משלוחים
                    html += '<div id="ApproveSelectedShippingProductsBar" style="position:fixed;bottom:0;left:0;width:100%;z-index:10;">'
                        + '<div style="max-width:500px;width:95%;margin:auto;position:relative;background:#ffffff;padding:8px 0;box-sizing:border-box;border-top:2px solid #cbcbcb;text-align:center;">'
                        + '<div id="ApproveSelectedShippingProductsBarContent"></div>'
                        + '</div>'
                        + '</div>';

                    $("#TabContent3").html(html);

                    // סימון שורה בלחיצה למשלוחים
                    // $("#ShippingProductsList .shipping-product-row").off("click").on("click", function () {
                    //     var idx = $(this).index();
                    //     var prod = shippingProducts[idx];
                    //     var id = prod.id;
                    //     if (window.SelectedShippingProducts.indexOf(id) === -1) {
                    //         window.SelectedShippingProducts.push(id);
                    //     } else {
                    //         window.SelectedShippingProducts = window.SelectedShippingProducts.filter(function (pid) { return pid !== id });
                    //     }
                    //     updateSelectedShippingProductsUI(shippingProducts);
                    // });

                    // // עדכון UI ראשוני למשלוחים
                    // updateSelectedShippingProductsUI(shippingProducts);
                }).error(function () {
                    MySwal("שגיאה בקבלת נתונים. בדוק תקשורת");
                });
            }

            // פונקציה ליצירת שורת מוצר למשלוח
            function renderShippingProductRow(prod, idx) {

                var html = '';
                html += '<div class="shipping-product-row" data-product-id="' + prod.id + '" style="display: flex; align-items: stretch; text-align: right; position: relative; border-radius: 5px; margin: 5px auto; background: #f0f8ff; font-size: 18px; box-sizing: border-box; border: 2px solid #e7e7e7; overflow: visible; min-height: 40px; transition: background 0.2s, border 0.2s;">';
                html += '<div style="background: #607d8b; color: white; display: flex; align-items: center; justify-content: center; min-width: 45px; font-weight: bold; font-size: 20px; position: relative;">';
                html += '<span style="font-size: 20px; font-weight: bold; padding: 0 2px;">' + (prod.productPlace || '') + '</span>';
                html += '<i class="fa-solid fa-truck" style="font-size: 12px; position: absolute; top: 1px; left: 50%; transform: translateX(-50%); opacity: 0.8;"></i>';
                html += '</div>';
                html += '<div style="flex: 1; padding: 5px 8px; display: flex; align-items: center; word-wrap: break-word; min-height: 40px;">';
                html += '<div style="font-size: 18px; color: #666;">' + (prod.productName || '') + '</div>';
                html += '</div>';
                html += '<div style="background: #607d8b; color: white; display: flex; align-items: center; justify-content: center; min-width: 45px; font-weight: bold; font-size: 25px; position: relative;">';
                html += '<span style="position: relative; top: -3px; padding: 0 2px;">' + (prod.quantityOrWeight || '') + '</span>';
                html += '<span style="font-size: 10px; position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); opacity: 0.8;">יח&#39;</span>';
                html += '</div>';
                html += '</div>';
                return html;
            }

            function GetOrders() {
                // איפוס בחירות בטאב 3 בכל רענון                
                window.SelectedOrders = [];
                $.ajax({
                    url: `${window.baseUrl}posApi/orders`,
                    context: Text,
                    timeout: 16000,
                    headers: {
                        "authorization": UserToken
                    }
                }).success(function (Response) {
                    if (Response.status == 'error') {
                        MySwal(Response.massege)
                        return false;
                    }
                    ListOrders = Response.data

                    // מערך בחירות למשלוחים
                    window.SelectedOrders = window.SelectedOrders || [];
                    var html = '';
                    html += '<div style="padding: 0 10px 70px;">';
                    html += '<input autocomplete="off" type="search" id="Filter_Search" oninput="Filter_Search()" placeholder="חיפוש מספר הזמנה" style="border: 1px solid rgb(212, 212, 212);outline-color: rgb(217 217 217);padding: 6px;font-size: 16px;background: rgb(255, 255, 255);text-align: center;margin-left: 6px;width: 211px;border-radius: 5px;height: 35px;">';

                    // טוגל בוטון לבחירת סוג התצוגה
                    html += '<div style="display: flex; justify-content: center; align-items: center; margin: 10px 0;">';
                    html += '<div style="background: #f0f0f0; border-radius: 25px; padding: 3px; display: inline-flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">';
                    html += '<button id="viewByOrders" onclick="toggleShippingViewMode(\'orders\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; color: ' + (window.ShippingViewMode === 'orders' ? 'white' : '#666') + '; background: ' + (window.ShippingViewMode === 'orders' ? '#009688' : 'transparent') + ';">הזמנות</button>';
                    html += '<button id="viewByProducts" onclick="toggleShippingViewMode(\'products\')" style="padding: 8px 16px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 0 2px; color: ' + (window.ShippingViewMode === 'products' ? 'white' : '#666') + '; background: ' + (window.ShippingViewMode === 'products' ? '#009688' : 'transparent') + ';">כמויות</button>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div id="OrdersList">';
                    if (Response.data.length === 0) {
                        html += '<div style="text-align:center; color:#bdbdbd; font-size:15px; padding:10px 0;">אין משלוחים ברשימה</div>';
                    } else {
                        for (var i = 0; i < Response.data.length; i++) {
                            var order = Response.data[i];
                            html += '<div class="order-row" data-order-id="' + order.orderId + '" style="display: flex; flex-direction: column; text-align: right; position: relative; border-radius: 5px; margin: 7px auto; background: #fffdfa; font-size: 15px; box-sizing: border-box; border: 2px solid #e7e7e7; overflow: hidden; min-height: 40px; transition: background 0.2s, border 0.2s;">';
                            html += '<div style="display: flex; align-items: stretch; min-height: 40px;">';
                            // חלק מיקום (collectionGroupOrder) - צד ימין כמו בטאב 1
                            html += '<div style="background: #1976d2; color: white; display: flex; align-items: stretch; justify-content: center; min-width: 40px; font-weight: bold; font-size: 16px; height: auto; position: relative;">';
                            html += '<span style="margin:auto 0;display:block;width:100%;text-align:center;font-size: 16px; font-weight: bold; padding: 0 2px;">' + (order.collectionGroupOrder || '') + '</span>';
                            html += '</div>';
                            // חלק עיקרי
                            html += '<div style="flex:2; padding: 5px 8px; display: flex; flex-direction: column; justify-content: center; min-width:0;">';
                            html += '<div style="font-size: 16px;font-weight: 600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + order.fullName + '</div>';
                            html += '<div style="font-size: 14px;color: #666; margin-top: 2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">הזמנה: ' + order.nbsOrderId + '</div>';
                            // כתובת
                            var address = order.street;
                            if (order.houseNumber) address += ' ' + order.houseNumber;
                            if (order.entrance) address += ', כניסה ' + order.entrance;
                            if (order.floor) address += ', קומה ' + order.floor;
                            if (order.apartment) address += ', דירה ' + order.apartment;
                            html += '<div style="font-size: 14px;color: #666; margin-top: 2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + address + '</div>';
                            if (order.phone) {
                                html += '<div style="font-size: 14px;color: #666; margin-top: 2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">טל: ' + order.phone + '</div>';
                            }
                            html += '</div>';
                            html += '</div>'; // סגירת flex הראשי
                            // חלק הערות בתחתית השורה
                            var hasNotes = (order.note && order.note.trim() !== "") || (order.notes && Array.isArray(order.notes) && order.notes.length > 0);
                            if (hasNotes) {
                                html += '<div style="width:100%;border-top:1px solid #e0e0e0;margin-top:0px;padding-top:5px;display:flex;flex-wrap:wrap;gap:6px 8px;">';
                                // הערה בודדת (string)
                                if (order.note && order.note.trim() !== "") {
                                    html += '<div style="display:inline-block;min-width:32px;max-width:100%;background:#ff9800;color:#fff;font-weight:bold;padding:5px 13px;border-radius:50px;font-size:13px;margin-bottom:2px;box-shadow:0 1px 2px #0001;white-space:normal;word-break:break-word;text-align:center;">' + order.note + '</div>';
                                }
                                // מערך הערות (notes)
                                if (order.notes && Array.isArray(order.notes) && order.notes.length > 0) {
                                    for (var n = 0; n < order.notes.length; n++) {
                                        var noteStr = order.notes[n];
                                        if (noteStr && noteStr.trim() !== "") {
                                            html += '<div style="display:inline-block;min-width:32px;max-width:100%;background:#1976d2;color:#fff;font-weight:bold;padding:5px 13px;border-radius:50px;font-size:13px;margin-bottom:2px;box-shadow:0 1px 2px #0001;white-space:normal;word-break:break-word;text-align:center;">' + noteStr + '</div>';
                                        }
                                    }
                                }
                                html += '</div>';
                            }
                            html += '</div>';
                        }
                    }
                    html += '</div>';
                    html += '</div>';
                    // פס קבוע בתחתית TAB
                    html += '<div id="ApproveSelectedShipmentsBar" style="position:fixed;bottom:0;left:0;width:100%;z-index:10;">'
                        + '<div style="max-width:500px;width:95%;margin:auto;position:relative;background:#ffffff;padding:8px 0;box-sizing:border-box;border-top:2px solid #cbcbcb;text-align:center;">'
                        + '<div id="ApproveSelectedShipmentsBarContent"></div>'
                        + '</div>'
                        + '</div>';
                    $("#TabContent3").html(html);

                    // סימון שורה בלחיצה
                    $("#OrdersList .order-row").off("click").on("click", function () {
                        var id = $(this).data('order-id');
                        if (window.SelectedOrders.indexOf(id) === -1) {
                            window.SelectedOrders.push(id);
                        } else {
                            window.SelectedOrders = window.SelectedOrders.filter(function (oid) { return oid !== id });
                        }
                        updateSelectedShipmentsUI(Response.data);
                    });

                    // עדכון UI ראשוני
                    updateSelectedShipmentsUI(Response.data);
                    Filter_Search();
                    Top();
                }).error(function () {
                    MySwal("שגיאה בקבלת נתונים. בדוק תקשורת")
                })
            }

            // עדכון UI של בחירה וכפתור אישור מרובה למשלוחים
            function updateSelectedShipmentsUI(orders) {
                $("#OrdersList .order-row").each(function (idx) {
                    var id = $(this).data('order-id');
                    if (window.SelectedOrders && window.SelectedOrders.indexOf(id) !== -1) {
                        $(this).css({ "background": "#e0f7fa", "border": "2.5px solid #009688" });
                    } else {
                        $(this).css({ "background": "#fffdfa", "border": "2px solid #e7e7e7" });
                    }
                });
                if (!window.SelectedOrders || window.SelectedOrders.length === 0) {
                    $("#ApproveSelectedShipmentsBarContent").html('<span style="color:#888;font-size:17px;">לחץ על שורה כדי לבחור</span>');
                } else {
                    $("#ApproveSelectedShipmentsBarContent").html(
                        '<div style="display:flex;justify-content:space-between;align-items:center;height:100%;width:100%;gap:10px;">' +
                        '<div onclick="approveSelectedShipments(true)" style="display:inline-flex;align-items:center;justify-content:center;background:#ff9800;font-weight:bold;color:white;cursor:pointer;padding:10px 15px;box-sizing:border-box;border-radius:3px;font-size:16px;flex:1;"><span>אישור עם צינתוק</span></div>' +
                        '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;color:#333;font-weight:bold;">' +
                        '<span style="font-size:18px;">' + window.SelectedOrders.length + '</span>' +
                        '<span style="font-size:12px;">נבחרו</span>' +
                        '</div>' +
                        '<div onclick="approveSelectedShipments(false)" style="display:inline-flex;align-items:center;justify-content:center;background:#8bc34a;font-weight:bold;color:#4a4a4a;cursor:pointer;padding:10px 15px;box-sizing:border-box;border-radius:3px;font-size:16px;flex:1;"><span>אישור בלי צינתוק</span></div>' +
                        '</div>'
                    );
                }
            }

            // פונקציית אישור מרובה למשלוחים
            function approveSelectedShipments(isTzintuk) {
                if (!window.SelectedOrders || window.SelectedOrders.length === 0) return;
                var selectedNames = [];
                var orders = [];
                $("#OrdersList .order-row").each(function (idx) {
                    var name = $(this).find('div').eq(0).find('div').eq(0).text();
                    var id = $(this).data('order-id');
                    if (window.SelectedOrders.indexOf(id) !== -1) {
                        selectedNames.push(name);
                        orders.push(id);
                    }
                });
                var tzintukText = isTzintuk ? ' עם צינתוק' : ' בלי צינתוק';
                swal({
                    type: "warning",
                    title: "האם לאשר את כל המשלוחים שנבחרו" + tzintukText + "?",
                    text: selectedNames.join("\n"),
                    showConfirmButton: true,
                    confirmButtonText: 'אישור',
                    confirmButtonColor: 'rgb(140, 212, 245)',
                    showCancelButton: true,
                    cancelButtonText: 'ביטול',
                    allowOutsideClick: false,
                    html: true
                }, function (res) {
                    if (res == true) {
                        $.ajax({
                            type: "POST",
                            url: `${window.baseUrl}posApi/approveOrders`,
                            data: {
                                "orders": window.SelectedOrders,
                                "isTzintuk": isTzintuk
                            },
                            context: Text,
                            timeout: 60000,
                            headers: {
                                "authorization": UserToken
                            }
                        }).success(function (Response) {
                            if (Response.status == 'error') {
                                MySwal(Response.massege)
                                return false;
                            }
                            window.SelectedOrders = [];
                            ShowTab(3);
                            MySwal(Response.massege, undefined, "success");
                        }).error(function () {
                            MySwal("שגיאה בקבלת נתונים. בדוק תקשורת");
                        });
                    }
                });
            }

            // פונקציית מעבר בין מצבי התצוגה בטאב 3
            function toggleShippingViewMode(mode) {
                window.ShippingViewMode = mode;
                if (mode === 'orders') {
                    GetOrders(); // רענון הנתונים עם הזמנות
                } else if (mode === 'products') {
                    GetShippingProducts(); // רענון הנתונים עם מוצרי משלוח
                }
            }


            function Filter_Search() {
                var $input = $('#Filter_Search');
                if ($input.length === 0) return false;
                var val = $input.val();
                if (val == undefined || val == null) return false;
                val = val.trim();
                if (val === "") {
                    $input.css('background', '#ffffff');
                } else {
                    $input.css('background', 'blanchedalmond');
                }

                // טאב 3 (משלוחים) - סינון order-row
                if (CurrentTab === 3 && $("#OrdersList .order-row").length > 0) {
                    var keywords = val.split(' ');
                    $("#OrdersList .order-row").each(function () {
                        var $row = $(this);
                        var text = $row.text().replace(/\s+/g, ' ').trim();
                        var show = true;
                        for (var j = 0; j < keywords.length; j++) {
                            if (keywords[j] && text.indexOf(keywords[j]) === -1) {
                                show = false;
                                break;
                            }
                        }
                        $row.toggle(show);
                    });
                    return;
                }

                // טאב 1 (איסוף) - סינון הזמנות
                if (CurrentTab === 1 && $("#Tab1List .order-row").length > 0) {
                    var keywords = val.split(' ');
                    $("#Tab1List .order-row").each(function () {
                        var $row = $(this);
                        var text = $row.text().replace(/\s+/g, ' ').trim();
                        var show = true;
                        for (var j = 0; j < keywords.length; j++) {
                            if (keywords[j] && text.indexOf(keywords[j]) === -1) {
                                show = false;
                                break;
                            }
                        }
                        $row.toggle(show);
                    });
                    return;
                }

                // טאב 2 (פיזור) - אין סינון

                // fallback ישן (אם אין רשימות חדשות)
                var KeyWord = val.split(' ');
                for (var i = 0; i < ListOrders.length; i++) {
                    var Exist = true;
                    for (var j = 0; j < KeyWord.length; j++) {
                        if (ListOrders[i].fullSearch && ListOrders[i].fullSearch.indexOf(KeyWord[j]) < 0) { Exist = false; }
                    }
                    if (Exist == true) {
                        $("#Row_" + i + "_Buildings").show();
                    } else {
                        $("#Row_" + i + "_Buildings").hide();
                    }
                }
            }

            function approveOrder(Id, IsList) {
                if (!IsList) {
                    var V = []
                    V.push(Id)
                    Id = V
                }

                swal({
                    type: "warning",
                    title: "האם אתה בטוח שברצונך לאשר" + (IsList == true ? " " + Id.length + ' הזמנות' : '') + "?",
                    text: "שים לב אין אפשרות לבטל את הפעולה",
                    showConfirmButton: true,
                    confirmButtonText: 'אישור',
                    confirmButtonColor: 'rgb(140, 212, 245)',
                    showCancelButton: true,
                    cancelButtonText: 'ביטול',
                    allowOutsideClick: false,
                    html: true
                }, function (res) {
                    if (res == true) {

                        $.ajax({
                            type: "POST",
                            url: `${window.baseUrl}posApi/approveOrders`,
                            data: { "orders": Id },
                            context: Text,
                            timeout: 60000,
                            headers: {
                                "authorization": UserToken
                            }
                        }).success(function (Response) {

                            if (Response.status == 'error') {
                                MySwal(Response.massege)
                                return false;
                            }


                            GetOrders()
                            MySwal(Response.massege, undefined, "success")


                        }).error(function () {
                            MySwal("שגיאה בקבלת נתונים. בדוק תקשורת")
                        })
                    }
                });
            }

            function SendMesaage(Id) {
                swal({
                    title: "שליחת הודעה",
                    text: "נא להקליד את ההודעה",
                    type: "input",
                    showCancelButton: true,
                    closeOnConfirm: false,
                    confirmButtonColor: "rgb(140, 212, 245)",
                    confirmButtonText: 'שליחה',
                    cancelButtonText: "ביטול",
                    showLoaderOnConfirm: true,
                }, function (inputValue) {
                    if (inputValue === false) {
                        return false;
                    }

                    if (inputValue === "") {
                        swal.showInputError("לא ניתן לשלוח הודעה ריקה");
                        return false
                    }


                    var JsonSend = { "message": inputValue };
                    if (Id != "") JsonSend.buildId = Id;


                    $.ajax({
                        type: "POST",
                        url: `${window.baseUrl}posApi/message`,
                        data: JsonSend,
                        context: Text,
                        timeout: 60000,
                        headers: {
                            "authorization": UserToken
                        }
                    }).success(function (Response) {

                        if (Response.status == 'error') {
                            MySwal(Response.massege)
                            return false;
                        }

                        swal.close()
                        MySwal(Response.massege, undefined, "success")

                    }).error(function () {
                        MySwal("שגיאה בקבלת נתונים. בדוק תקשורת")
                    })
                });
            }


            function UpdateListChecke() {
                var UpdateList = []

                for (var i = 0; i < ListOrders.length; i++) {
                    if ($('#Row_' + i + '_Buildings').attr('click') == "1") {
                        UpdateList.push(ListOrders[i].id)
                    }
                }

                if (UpdateList.length > 0) {
                    $("#UpdateList_Options").css('display', 'flex');

                } else {
                    $("#UpdateList_Options").hide();
                }


                $("#UpdateList_Options_BtSave").html("עדכון " + UpdateList.length + " הזמנות")
            }


            function UpdateList_Save() {
                var UpdateList = []

                for (var i = 0; i < ListOrders.length; i++) {
                    if ($('#Row_' + i + '_Buildings').attr('click') == "1") {
                        UpdateList.push(ListOrders[i].orderId)
                    }
                }

                approveOrder(UpdateList, true)
            }


            function Top() {
                setTimeout(function () {
                    $('html, body').scrollTop(0);
                }, 100)
            }


        </script>




        <div id="AlertTopPage"
            style="position: fixed; top: -100px; z-index: 100000000; left: 0; right: 0; pointer-events: none; padding-bottom: 27px;transition:0.3s;">
            <div id="AlertTopPage_Data"
                style="margin: auto; width: max-content; background: white; box-shadow: 0 0 20px 4px #bdbdbd; border-radius: 40px; padding: 12px 22px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #535353;">
                <i style="color: green;margin-left:10px;" class="fa-regular fa-circle-check"></i>
                <span>עודכן בהצלחה</span>
            </div>
        </div>




        <div id="CheckUser" class="Card" style="display:none;">
            <div
                style="padding: 20px; text-align: center; font-size: 22px; color: rgb(43 47 78); font-weight: 900; direction: rtl; border-bottom: 1px solid #d9d9d9;">
                כניסה למערכת</div>

            <div style="display: flex; justify-content: center; align-items: center; padding: 10px; flex-wrap: wrap;">
                <div>
                    <div style="margin: 10px 0px 3px; color: #607D8B; font-size: large; text-align: center; font-weight: bold; "
                        id="CheckUserNameKoteret">הזן שם:</div>
                    <div style="text-align:center" id="CheckUserNameDiv"><input value="" id="CheckUserName"
                            class="TextBox" type="text" dir="ltr" autocomplete="off" maxlength="11"
                            style="border-color: #9eafb6; max-width: 200px; border-width: 1px; text-align: center; font-weight: bold; font-size: 19px; height: 41px; ">
                    </div>
                </div>

                <div>
                    <div style="margin: 10px 0px 3px; color: #607D8B; font-size: large; text-align: center; font-weight: bold; "
                        id="CheckUserPassKoteret">הזן סיסמה:</div>
                    <div style="text-align:center" id="CheckUserPassDiv"><input value="" id="CheckUserPass"
                            class="TextBox" type="password" dir="ltr" autocomplete="off" maxlength="11"
                            style="border-color: #9eafb6; max-width: 200px; border-width: 1px; text-align: center; font-weight: bold; font-size: 19px; height: 41px; ">
                    </div>
                </div>
            </div>

            <div style="text-align:center;margin:10px" id="CheckUserSave"><input class="Bt"
                    style="padding: 9px; margin: 0px; background-color: #607D8B; max-width: 200px; width: 95%;"
                    type="button" id="CheckUserBtSave" value="אישור" onclick="CheckUser()"> </div>

            <div
                style="text-align: center; border-top: 1px solid #d1d5dbba; padding: 6px 0 0; color: #384252c4; font-weight: 600; font-size: 16px; margin: 15px 30px 10px;">
                לכניסה ע"י העברת כרטיס <span style="text-decoration: underline; cursor: pointer; color: #056db9;"
                    onclick="OpenCardGetMagneticCard()">לחץ כאן</span></div>



        </div>







        <div id="DivOrders" style="display: none;" class="Card">
            <!-- Unified Navigation Bar -->
            <div id="unifiedNav">
                <div id="topBar">
                    <!-- Right Actions (RTL): Hamburger Menu and Refresh -->
                    <div id="rightActions">
                        <div class="nav-btn" id="hamburgerMenu" onclick="toggleMenu()" title="תפריט">
                            <i class="fa-solid fa-bars"></i>
                        </div>
                        <div class="nav-btn" onclick="ShowTab()" title="רענון">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </div>
                    </div>

                    <!-- Center: Screen Name and Employee Name -->
                    <div id="centerInfo">
                        <div id="screenName">בחר מסך</div>
                        <div id="employeeName" class="UserName"></div>
                    </div>

                    <!-- Left Actions (RTL): Messages and Exit -->
                    <div id="leftActions">
                        <div class="BatteryStatus nav-btn" onclick="GetBattery()" title="סוללה"></div>
                        <div class="nav-btn" id="messagesBtn" onclick="ShowTab(4)" title="הודעות">
                            <i class="fa-regular fa-envelope"></i>
                            <span id="UnreadMessagesCount" style="position: absolute; top: 3px; right: 3px; background: #ff0000; color: white; border-radius: 50%; min-width: 16px; height: 16px; display: none; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; padding: 0 3px; line-height: 16px;"></span>
                        </div>
                        <div class="nav-btn" onclick="history.go(0);" title="יציאה">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </div>
                    </div>
                </div>

                <!-- Dropdown Menu -->
                <div id="menuDropdown">
                    <div class="menu-item" onclick="ShowTab(1);">
                        <i class="fa-solid fa-box"></i>
                        <span>הזמנות</span>
                    </div>
                    <div class="menu-item" onclick="ShowTab(2);">
                        <i class="fa-solid fa-hand-holding"></i>
                        <span>ליקוט</span>
                    </div>
                    <div class="menu-item" onclick="ShowTab(3);">
                        <i class="fa-solid fa-truck"></i>
                        <span>משלוחים</span>
                    </div>
                    <div class="menu-item" onclick="ShowTab(4);">
                        <i class="fa-regular fa-envelope"></i>
                        <span>הודעות</span>
                    </div>
                    <div class="menu-item" onclick="ShowTab(5);">
                        <i class="fa-solid fa-clipboard-list"></i>
                        <span>ספירת מלאי</span>
                    </div>
                    <div class="menu-item" onclick="ShowTab(6);">
                        <i class="fa-solid fa-tags"></i>
                        <span>מדבקות מיקום</span>
                    </div>
                </div>
            </div>
            <div id="TabContent0" style="display:none;">
                <!-- Selection screen will be created dynamically -->
            </div>
            <div id="TabContent1" style="display:none;">
                <div style="padding: 0 10px 20px;">
                    <div style="text-align: center; padding: 50px; font-size: 36px; font-weight: bold; color: #009688;">
                        טוען רשימת איסוף
                    </div>


                </div>

            </div>
            <div id="TabContent2" style="display:none;">
                <div style="text-align: center; padding: 50px; font-size: 36px; font-weight: bold; color: #009688;">
                    טוען רשימת פיזור</div>
            </div>
            <div id="TabContent3" style="display:none;">

                <div style="display: flex; justify-content: center; align-items: center; padding: 0 10px 20px;">
                    <input autocomplete="off" type="search" id="Filter_Search" oninput="Filter_Search()"
                        placeholder="חיפוש הזמנה"
                        style="border: 1px solid rgb(212, 212, 212);outline-color: rgb(217 217 217);padding: 6px;font-size: 16px;background: rgb(255, 255, 255);text-align: center;margin-left: 6px;width: 211px;border-radius: 5px;height: 35px;">
                </div>




                <div id="DivBuildings_Data" style="padding: 0 10px 52px;"></div>




                <div style="position:fixed;bottom:0;left:0;width:100%;" id="UpdateList_Options">
                    <div
                        style="max-width: 500px; width: 95%; margin: auto; position: relative; background: #ffffff; padding: 8px; box-sizing: border-box; border-top: 2px solid #cbcbcb; ">

                        <div style="display: flex; justify-content: center; align-items: center;">
                            <div onclick="UpdateList_Save()" id="UpdateList_Options_Bt"
                                style="display: flex; justify-content: center; align-items: center; background: #8bc34a; font-weight: bold; color: #4a4a4a; cursor: pointer; width: max-content; height: 100%; padding: 10px; box-sizing: border-box; border-radius: 3px; height: 35px; margin: 0 10px; ">
                                <i class="fa-solid fa-check"></i>
                                <span style="padding: 0 5px 0 0;" id="UpdateList_Options_BtSave">אשר 15 הזמנות</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="TabContent4" style="display:none;">
                <div style="padding: 0 10px 20px;">
                    <div style="text-align: center; padding: 50px; font-size: 36px; font-weight: bold; color: #009688;">
                        טוען רשימת הודעות...
                    </div>


                </div>

            </div>
            <div id="TabContent5" style="display:none;">
                <!-- Inventory count screen - placeholder -->
            </div>
            <div id="TabContent6" style="display:none;">
                <!-- Location labels screen - placeholder -->
            </div>
        </div>
    </div>

    <div id="CardGetMagneticCard" style="max-width: 500px;margin:auto;"></div>
    <div id="Height_POS" style="height:200px;display:none;"></div>

    <div id="CreditCardData" style="display:none"></div>



    <script type="text/javascript" src="Files/FormsFunction.js"></script>


    <script>
        var MySwalTimeOut;
        function MySwal(Text, Id, Type) {
            if (Type == "success") {
                $("#AlertTopPage").css("top", "20px")
                $("#AlertTopPage_Data span").html(Text)
                $("#AlertTopPage_Data i").css("color", "green")

                clearTimeout(MySwalTimeOut)
                MySwalTimeOut = setTimeout(function () {
                    $("#AlertTopPage").css("top", "-100px")
                }, 3500)
            }

            else {
                swal({
                    type: Type || "error",
                    title: Text,
                    html: true,
                    showConfirmButton: true,
                    allowOutsideClick: false,
                }, function () {
                    if (Id) {
                        $('#' + Id).focus()
                        $('#' + Id).select();
                        ScrollUp('#' + Id)
                    }
                    setTimeout(function () {
                        $("#SaveDiv").show()
                        $("#WaitDiv").hide()
                    }, 100);
                });
            }
        }








        $(document).ready(function () {
            $('body').unbind().bind('keydown', function (e) {
                if ($("#CardGetMagneticCard").css('display') != 'none' && _IsQpos == false) {
                    if (LastPress == 'Done') { LastPress = $.now(); $("#CreditCardData").html(''); CheckLastCardReader() }
                    LastPress = $.now()

                    if ($("#CreditCardData").html().length > 4) {
                        $("#CardTransferCard").css('background', '#b7d694');
                        $("#CardTransferCard span").html('קורא נתוני כרטיס');
                    }
                    if (e.shiftKey == false) $("#CreditCardData").append(String.fromCharCode(e.which));
                }
            }).on("click", function () {
                if ($("#AlertTopPage").css('top') != '-100px') {
                    $("#AlertTopPage").css("top", "-100px")
                    clearTimeout(MySwalTimeOut)
                }
            })


            if (window.innerWidth < 400) {
                $('body').css('margin', '0px')
            }


            OpenCardGetMagneticCard()
            // ShowMainScreen()

            GetBattery()
        })





        var LastPress = 'Done'
        function CheckLastCardReader(skip) {
            if (LastPress == 'Done' && skip != true) return false;
            var dif = ($.now() - LastPress)
            if (dif > 400 || skip == true) {
                LastPress = 'Done'

                $.ajax({
                    type: "POST",
                    url: `${window.baseUrl}posApi/login`,
                    data: { "cardNumber": $("#CreditCardData").html().replace("»", "=").replace("º", "").replace("ף", "").replace(";", "") },
                    context: Text,
                    timeout: 60000,
                }).success(function (Response) {
                    if (Response.status == "error") {
                        MySwal(Response.massege)
                        OpenCardGetMagneticCard()
                        return false;
                    }


                    UserToken = "Bearer " + Response.token
                    // UserType = Response.userType
                    UserName = Response.userName
                    $(".UserName").html(UserName)

                    ShowMainScreen()

                }).error(function () {
                    MySwal("תקלת תקשורת")
                }).complete(function () {
                    if (_IsQpos == true) {
                        $("#CardTransferCard").css('background', 'none');
                        $("#CardTransferCard span").html('העבר כרטיס<div style="display:block;color:indianred;font-size: 2vh;">פס מגנטי כלפי מטה</div>')
                    } else {
                        $("#CardTransferCard").css('background', 'none');
                        $("#CardTransferCard span").html('העבר כרטיס בקורא מגנטי')
                    }
                })

            } else {
                setTimeout(function () { CheckLastCardReader() }, 100);
            };
        }





        var _IsQpos = undefined
        var _POS_Firmware = undefined
        var _POS_Sign = undefined
        var OpenPOSTimeout = undefined
        var OpenPOSInterval = undefined
        var Count_OpenPOSInterval = 0


        function OpenCardGetMagneticCard() {
            clearTimeout(OpenPOSTimeout);
            clearInterval(OpenPOSInterval);
            Count_OpenPOSInterval = 0

            if (_IsQpos == undefined) {
                try {
                    var Json = JSON.parse(PosNedarim.GetDevicesStatus());
                    _IsQpos = true;
                    _POS_Firmware = Json.Firmware
                    _POS_Sign = Json.SignType
                    $("#Height_POS").show();
                } catch (err) {
                    _IsQpos = false;
                }
            }


            var html = ""
            if (_IsQpos == true) {
                html += '<div id="CardTransferCard" style="margin: 17px 15px;font-weight: bold;color: #474747;font-size: 18px;text-align: center;padding: 13px;"><span>העבר כרטיס<div style="display:block;color:indianred;font-size: 2vh;">פס מגנטי כלפי מטה</div></span><img src="/NedarimPlus/POS/Files/Swipe.png" style="width:200px;display:block;margin-right: auto; margin-left: auto;"></div>'

                html += '<div onclick="$(\'#CheckUser\').show(); $(\'#CardGetMagneticCard\').hide(); $(\'#CheckUserName\').focus();" style="cursor: pointer; margin: 17px 15px; background: linear-gradient(rgb(221 221 221), rgb(235 235 235), rgb(219 219 219)); font-weight: bold; color: #474747; font-size: 18px; text-align: center; padding: 13px;">לחץ כאן להתחברות ע"י הזנת פרטים<img src="/NedarimPlus/POS/Files/Manual.png" style="width:200px;display:block;margin-right: auto; margin-left: auto;" /></div>';
                if (_POS_Firmware == 'D20_SZFP_release_20221119' && _POS_Sign !== 'Normal') html += '<div style="font-size: 2.5vh;background-color: #fb7455;color: white;padding: 4px 0px;border-radius: 3px;display: inline-block;font-weight: 600;position: absolute;top: 60px;opacity: 0.9;width: 100%;left: 0;">במידה ומכשיר זה אינו מגיב להעברת כרטיס,<br />נסו לבצע הפעלה מחדש כעת.<br/><u>והשתדלו להשאירו מנותק מהחשמל</u><br />(שמנו לב שיש פחות בעיות כשלא מחובר למטען)<br /><b>הנושא בטיפול מול היצרן. עמכם הסליחה.</b></div>';

                OpenPOSTimeout = setTimeout(function () {
                    try {
                        PosNedarim.OpenPOS();
                    } catch (err) {
                        PosNedarim.showToast("שגיאה בפתיחת קורא כרטיסים")
                    }
                }, 500)

            } else {

                html += '<div id="CardTransferCard" style="margin: 17px 15px;font-weight: bold;color: #474747;font-size: 18px;text-align: center;padding: 13px;"><span>העבר כרטיס בקורא מגנטי</span><img src="/NedarimPlus/POS/Files/SwipeNoPOS.png" style="width:200px;display:block;margin-right: auto; margin-left: auto;"></div>'
                html += '<div onclick="$(\'#CheckUser\').show(); $(\'#CardGetMagneticCard\').hide(); $(\'#CheckUserName\').focus();" style="cursor: pointer; margin: 17px 15px; background: linear-gradient(rgb(221 221 221), rgb(235 235 235), rgb(219 219 219)); font-weight: bold; color: #474747; font-size: 18px; text-align: center; padding: 13px;">לחץ כאן להתחברות ע"י הזנת פרטים<img src="/NedarimPlus/POS/Files/Manual.png" style="width:200px;display:block;margin-right: auto; margin-left: auto;" /></div>';
            }

            $('#CardGetMagneticCard').html(html).show();

            if (_IsQpos == true) {
                OpenPOSInterval = setInterval(function () {
                    Count_OpenPOSInterval += 1
                    if (Count_OpenPOSInterval >= 60) {
                        $("#CardTransferCard").html('<div style="background: indianred; color: white;padding: 13px;" onclick="OpenCardGetMagneticCard()">קורא כרטיסים מושבת <br/> לחץ כאן כדי להפעיל</div>').css('padding', '0px');
                        clearInterval(OpenPOSInterval);
                    }
                }, 1000)
            }

            $('.Card').hide()
        }



        function POSAction(Action, Data1, Data2, Data3) {
            if (Action == 'AllowSwipe') {
                PosNedarim.showToast("קורא כרטיסים הופעל")
            }

            if ($("#CardGetMagneticCard").css('display') !== "none") {
                if (Action == 'DoneSwipe') {
                    $("#CreditCardData").html(Data3);
                    CheckLastCardReader(true)

                } else if (Action == 'ErrorSwipe') {
                    if (Data2 == "CMD_TIMEOUT") {
                        $("#CardTransferCard").html('<div style="background: indianred; color: white;padding: 13px;" onclick="OpenCardGetMagneticCard()">קורא כרטיסים מושבת <br/> לחץ כאן כדי להפעיל</div>').css('padding', '0px');
                        clearInterval(OpenPOSInterval);
                        return false
                    };
                    try {
                        OpenCardGetMagneticCard()
                    } catch (err) {
                        PosNedarim.showToast("שגיאה")
                    };
                }
            }
        }



        function ReloadPOS() {
            if (_IsQpos == true) {
                PosNedarim.Reload()
            }
            else {
                history.go(0)
            }
        }




        var SetTimeoutGetBattery;
        function GetBattery() {
            clearTimeout(SetTimeoutGetBattery)
            try {
                var BatteryPOS = 0

                BatteryPOS = JSON.parse(PosNedarim.GetDevicesStatus())
                BatteryPOS = BatteryPOS.Battery.replace('%', '')


                if (BatteryPOS < 5) {
                    $(".BatteryStatus").html('<span style="font-size: 11px;">' + BatteryPOS + '%</span><i style="font-size: 21px; height: 19px;color: indianred;" class="fa-solid fa-battery-empty"></i>')
                }

                else if (BatteryPOS < 20) {
                    $(".BatteryStatus").html('<span style="font-size: 11px;">' + BatteryPOS + '%</span><i style="font-size: 21px; height: 19px;color: #ed7d5a;" class="fa-solid fa-battery-quarter"></i>')
                }

                else if (BatteryPOS < 40) {
                    $(".BatteryStatus").html('<span style="font-size: 11px;">' + BatteryPOS + '%</span><i style="font-size: 21px; height: 19px;color:#ffa500;" class="fa-solid fa-battery-half"></i>')
                }

                else if (BatteryPOS < 60) {
                    $(".BatteryStatus").html('<span style="font-size: 11px;">' + BatteryPOS + '%</span><i style="font-size: 21px; height: 19px;color:#8bc34a;" class="fa-solid fa-battery-three-quarters"></i>')
                }

                else {
                    $(".BatteryStatus").html('<span style="font-size: 11px;">' + BatteryPOS + '%</span><i style="font-size: 21px; height: 19px;color: green;" class="fa-solid fa-battery-full"></i>')
                }

                SetTimeoutGetBattery = setTimeout(function () {
                    GetBattery()
                }, 1000 * 60 * 10)
            }
            catch (err) {
                $(".BatteryStatus").hide()
            }
        }

    </script>
</body>

</html>